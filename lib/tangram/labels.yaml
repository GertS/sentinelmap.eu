# Refill provides a high contrast, black & white basemap useful for data visualization. 
# Give OpenStreetMap data a professional basemap skin using the Tangram graphics library 
# and Mapzen's versatile Vector Tiles. 
#
# Refill is a modern GL take on Geraldine's work on Toner for Stamen as part of their 
# great CityTracking project. Please use and adapt the open source scene file in  
# your own projects!
#
# Authors: Geraldine Sarmiento, Nathaniel V. Kelso
# Read more: https://github.com/tangrams/refill-style
# 

labels-global:
    - &text_visible_continent         true
    - &text_visible_admin             true
    - &text_visible_populated_places  true
    - &icon_visible_populated_places  true
    - &text_visible_neighbourhoods    true
    - &text_visible_neighbourhoods_e  true
    - &text_visible_building          true
    - &text_visible_address           true
    - &text_visible_water_labels      true
    - &label_visible_landuse_green    true
    - &icon_visible_landuse_green     true
    - &text_visible_landuse_green     true
    - &label_visible_poi_landuse      true
    - &icon_visible_poi_landuse       true
    - &text_visible_poi_landuse       true
    - &label_visible_poi_landuse_e    true
    - &icon_visible_poi_landuse_e     true
    - &text_visible_poi_landuse_e     true
    - &label_visible_station          true
    - &icon_visible_station           true
    - &text_visible_station           true
    - &text_visible_highway           true
    - &text_visible_highway_e         true
    - &text_visible_trunk_primary     true
    - &text_visible_trunk_primary_e2  false
    - &text_visible_trunk_primary_e   false
    - &text_visible_secondary         true
    - &text_visible_secondary_e       false
    - &text_visible_tertiary          true
    - &text_visible_tertiary_e        false
    - &text_visible_minor_road        true
    - &text_visible_minor_road_e      true
    - &text_visible_service_road      true
    - &text_visible_path              true
    - &text_visible_piste             true
    - &text_visible_steps             true
    - &text_visible_aerialway         true
    - &text_visible_shields           true
    - &text_visible_exits             true
    - &text_visible_exits_e           false
    - &text_visible_airport_gate      true

settings:
    cameras:             
        - &camera_settings            { type: isometric, axis: [0, .1], vanishing_point: [0, -500] }

    lights:
        - &light_settings             { type: directional, direction: [1, 1, -.9], diffuse: 0.5, ambient: 0.85 }

    roads:
        - &highway1                   [1.00,1.00,1.00]
        - &highway_link1              [0.00, 0.00, 0.00]
        - &highway_casing1            [0.40, 0.40, 0.40]
        - &highway_tunnel1            [0.7, 0.7, 0.7]
        - &highway_tunnel_casing1     [1.00, 1.00, 1.00]
        - &highway_link_tunnel_casing1 [1.00, 1.00, 1.00]
        - &ferry1                     [0.75,0.75,0.75]
        - &rail1                      '#999'
        - &rail1_e                    '#bbb'
        - &rail2                      '#777'             # less important rail (service, sidings)
        - &major_road1                [0.0, 0.0, 0.0]
        - &major_road1b               [0.935, 0.935, 0.935]
        - &major_road1c               white    #15%
        - &major_road2                [0.935, 0.935, 0.935]
        - &major_road2a               [0.935, 0.935, 0.935]
        - &major_road2b               [0.935, 0.935, 0.935]
        - &major_road3                [0.935, 0.935, 0.935]
        - &major_road4                [0.00, 0.00, 0.00]
        - &major_road5                white
        - &major_casing1              [0.40, 0.40, 0.40]        # same as highway_casing1
        - &major_casing2              [0.40, 0.40, 0.40]        # zoomed out
        - &major_tunnel1              [0.7, 0.7, 0.7]
        - &major_tunnel_casing1       [1.00, 1.00, 1.00]
        - &major_route1               [0.0, 0.0, 0.0]
        - &major_route2               [0.2, 0.2, 0.2]           # zoomed out
        - &minor_route                [0.97, 0.97, 0.97]        # same as major_route
        - &minor_road1                [0.935, 0.935, 0.935]     # natural earth
        - &minor_road2                [0.935, 0.935, 0.935]     # natural earth, same as major_road2
        - &minor_road3                [0.935, 0.935, 0.935]
        - &minor_road4                [0.935, 0.935, 0.935]     # zoomed out
        - &minor_road5                [0.935, 0.935, 0.935]     # zoomed out, again
        - &minor_casing1              white                     # same as highway_casing1
        - &minor_casing2              white                     # zoomed out
        - &minor_tunnel1              [0.7, 0.7, 0.7]
        - &minor_tunnel_casing1       [1.00, 1.00, 1.00]
        - &service_road1              [0.935, 0.935, 0.935]
        - &service_road2              white
        - &service_road_casing1       [0.40, 0.40, 0.40]
        - &service_road_casing2       white
        - &path1                      [0.97, 0.97, 0.97]
        - &path2                      [0.97, 0.97, 0.97]        # zoomed out
        - &path_casing1               [0.40, 0.40, 0.40]
        - &path_bridge_casing1        [0.40, 0.40, 0.40]
        - &path_bridge_casing2        [0.40, 0.40, 0.40]        # zoomed out
        - &path_steps1                red
        - &path_steps1_b              '#ccc'
        - &piste_easy                 [0.367,0.750,0.622]
        - &piste_intermediate         [0.420,0.678,0.863]
        - &piste_advanced             [0.450,0.450,0.450]
        - &piste_expert               [0.450,0.450,0.450]

    boundaries:
        - &country_boundary           '#ccc'
        - &region_boundary            '#ccc'
        - &subregion_boundary         '#ccc'
        - &city_wall                  [0.682,0.682,0.682]
        - &retaining_wall             [0.827,0.808,0.780]
        - &snow_fence                 [0.827,0.808,0.780]
        - &fence                      [0.827,0.808,0.780]

    areas:
        - &scene1      false                    # map background
        - &water1      [0.870, 0.870, 0.870]    # water wave
        - &water2      [0.760, 0.760, 0.760]    # water wave
        - &water3      [0.5, 0.5, 0.5]          # playa texture
        - &water1_o    '#fff'                   # water stroke (ocean coastline)
        - &water2_o    '#d1d1d1'                # water stroke 2 (streams, lake outlines)
        - &earth1      white                    # land color
        - &earth2      '#e9e4e0'                # urban
        - &earth2_v    false                    # urban
        - &green1      [0.50,0.50,0.50]         # park
        - &green1_r    '#bbbbbb'                # park roads
        - &green1_b    [.65, .65, .65]          # park buildings
        - &green1_bo   [.8, .8, .8]             # park building outlines
        - &green2      [0.90,0.90,0.90]         # cemetery
        - &green3      '#9a9a9a'                # golf course
        - &green4      [0.90,0.90,0.90]         # farm faint
        - &green4_v    false                    # farm faint
        - &green5      [0.75,0.75,0.75]         # farm
        - &green6      [0.40,0.40,0.40]         # nature reserve
        - &green7      [0.85,0.85,0.85]         # forest
        - &green8      [0.80,0.80,0.80]         # conservation
        - &green9      [0.85,0.85,0.85]         # forest (landcover)
        - &green9_e    [0.90,0.90,0.90]         # forest (landcover) early
        - &green9_v    true                     # forest (landcover) visibility
        - &green10     [0.85,0.85,0.85]         # sports_centre
        - &green11     [0.85,0.85,0.85]         # minor zoo related AOIs
        - &green11_o   [0.85,0.85,0.85]         # minor zoo related AOIs outline
        - &orange1     '#aaaaaa'                # stadium
        - &orange2     [0.40,0.40,0.40]         # pitch (play field)
        - &brown1      '#7b7b7b'                # university
        - &brown1_r    '#bbbbbb'                # university roads
        - &brown1_b    [.65, .65, .65]          # university buildings
        - &brown1_bo   [.8, .8, .8]             # university building outlines
        - &brown2      '#aaaaaa'                # school
        - &brown3      [0.40,0.40,0.40]         # playground
        - &red1        '#a2a2a2'                # hospital
        - &red1_r      '#bbbbbb'                # hospital roads
        - &red1_b      [.65, .65, .65]          # hospital buildings
        - &red1_bo     [.8, .8, .8]             # hospital building outlines
        - &grey1       '#cccccc'                # pedestrian, retail, airport apron, parking, church
        - &grey1_e     '#dad6d4'                # pedestrian, retail, airport apron, parking, church early zoom 14
        - &grey1_v     true                     # pedestrian, retail, airport apron, parking, church
        - &grey2       [0.5, 0.5, 0.5]          # airport runway
        - &grey3       '#bbbbbb'                # railway
        - &grey4       '#ffc52a'                # airport taxiway
        - &grey5       '#ffc52a'                # airport taxiway
        - &grey6       '#dddddd'                # industrial
        - &grey6_b     [.65, .65, .65]          # industrial buildings
        - &grey6_bo    [.8, .8, .8]             # industrial building outlines
        - &grey7       '#ecebe9'                # pedestrian, match minor road / path color
        - &grey7_v     true                     # pedestrian visibility
        - &grey8       '#ecebe9'                # winter sports
        - &grey8_v     true                     # winter sports visibility
        - &grey9       [.7, .0, .0, 0.5]        #[.7, .7, .7]        # transit platform
        - &grey9_o     [.5, .5, .5]             # transit platform outline
        - &grey9_v     true                     # transit platform visibility
        - &grey10      '#d4cce6'                # generic major landuse (theme park, resort, aquarium, winery)
        - &grey10_o    '#bcb9c5'                # generic major landuse outline
        - &grey11      '#d7d7d7'                # generic minor landuse (attraction, artwork)
        - &grey11_o    '#cccccc'                # generic minor landuse outline
        - &grey12      '#cfcfcf'                # generic minor amusements (roller coasters, rides, slide, carousel)
        - &grey12_o    '#c5c5c5'                # generic minor amusements
        - &purple      '#f0e1e1'                # airport
        - &purple_v    false                    # airport
        - &mystry1     '#aaaaaa'                # recreation ground (type of park, sometimes around reservoirs)
        - &building1   white                    # building
        - &building2   white                    # building stroke
        - &building_o  25                       # building stroke order
        - &building_e  true                     # building stroke order

    labels:
        - &text_fill   '#000'                       # WHITE
        - &text_fill2  '#000'                       # WHITE
        - &text_fill_road_e   '#555'                # WHITE
        - &text_fill_exits    [0.40,0.40,0.40]      # motorway junctions, highway_casing1
        - &text_fill_building '#000'                # tan
        - &text_fill_address  [0.60,0.60,0.60]      # HUH
        - &text_fill_water   '#000'                 # blue
        - &text_fill_park    [0.175,0.175,0.175]    # green
        - &text_fill_beach    [0.35,0.35,0.35]      # black
        - &text_fill_piste   [0.675,0.675,0.675]    # dark gray
        - &text_fill_piste_e [0.675,0.675,0.675]    # dark gray early
        - &text_stroke '#fff'                       # land color
        - &text_stroke_park '#fff'                  # land color
        - &text_stroke_water '#fff'
        - &text_stroke_address   [1.0,1.0,1.0]      # address stroke color
        - &townspot_sprite   townspot-m-rev         # depends on land color and text settings
        - &text_font_family  'Open Sans'            # branding in asperational Unicode, yo (or Helvetica)


textures:
    pois:
        url: images/poi_icons_18@2x.png
        filtering: mipmap
        sprites:
            # define sprites: [x origin, y origin, width, height]
            airport: [870, 0, 38, 38]
            aquarium: [732, 168, 38, 38]
            art-gallery: [640, 168, 38, 38]
            athletics-sports: [184, 168, 38, 38]
            atm: [918, 126, 38, 38]
            automotive-shop: [0, 168, 38, 38]
            bakery: [548, 168, 38, 38]
            bank: [964, 126, 38, 38]
            bar: [230, 168, 38, 38]
            baseball-field: [506, 84, 38, 38]
            basketball-court: [460, 84, 38, 38]
            beach: [644, 84, 38, 38]
            beer-garden: [276, 210, 38, 38]
            bench: [548, 0, 38, 38]
            bicycle-parking: [644, 126, 38, 38]
            bike-shop: [872, 126, 38, 38]
            boat-ferry: [824, 0, 38, 38]
            boat-ramp: [138, 84, 40, 38]
            bookstore: [826, 126, 38, 38]
            bridge: [920, 84, 38, 38]
            buddhism: [782, 84, 38, 38]
            building: [414, 168, 34, 34]
            burger: [138, 210, 38, 38]
            bus-station: [778, 0, 38, 38]
            butcher: [920, 42, 38, 38]
            campground: [828, 84, 38, 38]
            candy-store: [0, 210, 38, 38]
            capital-l: [514, 210, 16, 16]
            capital-m: [494, 210, 12, 12]
            capital-s: [474, 210, 10, 10]
            capital-xl: [538, 210, 20, 20]
            capital-xs: [460, 210, 8, 8]
            car-dealership: [780, 126, 38, 38]
            castle: [414, 42, 38, 38]
            cemetery: [736, 84, 38, 38]
            church: [230, 126, 38, 38]
            clothing-store: [824, 168, 38, 38]
            coffee-shop: [502, 168, 38, 38]
            college-university: [870, 168, 38, 38]
            convenience-store: [46, 84, 38, 38]
            courthouse: [364, 0, 38, 38]
            department-store: [734, 126, 38, 38]
            drinking-water: [230, 210, 38, 38]
            dry-cleaning: [0, 84, 38, 38]
            electronics-store: [598, 126, 38, 38]
            factory: [368, 168, 38, 38]
            fire-station: [318, 0, 38, 38]
            fitness: [874, 42, 38, 38]
            flower-shop: [184, 126, 38, 38]
            forest: [46, 210, 38, 38]
            fountain: [322, 126, 38, 38]
            garden: [690, 84, 38, 38]
            gas-station: [960, 168, 38, 38]
            generic: [414, 210, 38, 38]
            gift-shop: [138, 126, 38, 38]
            golf-course: [414, 84, 38, 38]
            government-building: [138, 168, 38, 38]
            grocery-store: [552, 126, 38, 38]
            harbor-marina: [92, 168, 40, 38]
            hardware-store: [828, 42, 38, 38]
            historic-site: [92, 126, 38, 38]
            hospital: [184, 0, 34, 34]
            hotel: [732, 0, 38, 38]
            ice-cream-shop: [322, 210, 38, 38]
            information: [368, 210, 38, 38]
            jewelry-store: [736, 42, 38, 38]
            landmark: [272, 0, 38, 38]
            laundry: [690, 42, 38, 38]
            library: [0, 0, 38, 38]
            light-rail: [686, 0, 38, 38]
            lighthouse: [276, 84, 38, 38]
            liquor-store: [506, 126, 38, 38]
            locate-off: [414, 342, 72, 72]
            locate-on: [334, 342, 72, 72]
            mall: [644, 42, 38, 38]
            market: [598, 42, 38, 38]
            mine: [782, 42, 40, 38]
            mobile-phone-shop: [506, 42, 38, 38]
            mosque: [92, 0, 38, 38]
            mountain: [230, 84, 38, 38]
            movie-theatre: [778, 168, 38, 38]
            museum: [46, 126, 38, 38]
            music-store: [368, 42, 38, 38]
            newsstand: [322, 42, 38, 38]
            office: [598, 84, 38, 38]
            optical-shop: [276, 42, 38, 38]
            park: [276, 126, 38, 38]
            parking: [690, 126, 38, 38]
            performing-arts: [594, 168, 38, 38]
            pet-store: [230, 42, 38, 38]
            pharmacy: [966, 42, 38, 38]
            photography-lab: [184, 42, 38, 38]
            pier: [640, 0, 38, 38]
            playground: [460, 42, 38, 38]
            police: [226, 0, 38, 38]
            pool: [184, 84, 38, 38]
            post-office: [322, 168, 38, 38]
            real-estate: [138, 42, 38, 38]
            recycling-facility: [92, 42, 38, 38]
            rental-car: [594, 0, 38, 38]
            restaurant: [92, 210, 38, 38]
            ruin: [502, 0, 38, 38]
            salon-barber: [46, 42, 38, 38]
            school: [552, 84, 38, 38]
            shoe-store: [552, 42, 38, 38]
            ski-area: [368, 126, 38, 38]
            soccer-field: [368, 84, 38, 38]
            spiritual-center: [276, 168, 38, 38]
            sporting-goods-shop: [0, 42, 38, 38]
            spring: [322, 84, 38, 38]
            stadium: [460, 126, 38, 38]
            subway-entrance: [456, 0, 38, 38]
            synagogue: [46, 0, 38, 38]
            tailor-shop: [962, 0, 38, 38]
            tennis: [414, 126, 38, 38]
            theme-park: [0, 126, 38, 38]
            toilets: [874, 84, 38, 38]
            townspot-l: [724, 210, 16, 16]
            townspot-l-rev: [618, 210, 16, 16]
            townspot-m: [704, 210, 12, 12]
            townspot-m-rev: [598, 210, 12, 12]
            townspot-s: [686, 210, 10, 10]
            townspot-s-rev: [580, 210, 10, 10]
            townspot-xl: [748, 210, 20, 20]
            townspot-xl-rev: [642, 210, 20, 20]
            townspot-xs: [670, 210, 8, 8]
            townspot-xs-rev: [566, 210, 6, 6]
            toy-game-store: [916, 0, 38, 38]
            traffic-signal: [916, 168, 36, 34]
            train-station: [410, 0, 38, 38]
            veterinarian: [138, 0, 38, 38]
            view-point: [686, 168, 40, 38]
            vineyard: [46, 168, 40, 38]
            volcano: [92, 84, 38, 38]
            wine-bar: [184, 210, 38, 38]
            winery: [456, 168, 38, 38]
            zoo: [966, 84, 38, 38]
            #
            # UX/UI icons for map interactivity & app chrome
            #
            ux-current-location: [80, 342, 88, 88]
            ux-route-arrow: [776, 210, 128, 128]
            ux-route-start: [0, 342, 72, 92]
            ux-route-stop: [912, 210, 72, 92]
            ux-search-active: [174, 342, 72, 108]
            ux-search-inactive: [254, 342, 72, 108]
            # ux-transit-stop is currently reusing capital-xl artwork, please customize
            ux-transit-stop: [538, 210, 20, 20]

    building-grid:
        url: images/building-grid.gif
        filtering: mipmap

sources:
    osm:
        type: TopoJSON #GeoJSON, MVT, TopoJSON
        url:  https://vector.mapzen.com/osm/all/{z}/{x}/{y}.topojson?api_key=vector-tiles-Y3DcPK9
        # url:  //vector.mapzen.com/osm/all/{z}/{x}/{y}.topojson?api_key=vector-tiles-Y3DcPK9
        # url:  http://vector.dev.mapzen.com/osm/all/{z}/{x}/{y}.topojson
        # url:  //localhost:8080//osm/all/{z}/{x}/{y}.topojson
        # type: MVT
        # url:  http://vector.mapzen.com/osm/all/{z}/{x}/{y}.mvt
        max_zoom: 14

    # # Only enable this for local debug, should not be enabled for prod (app inserts these at runtime)
    # # These are all in San Francisco, California
    # # 
    # # Current location gem
    # mz_current_location:
    #     type: GeoJSON
    #     url: https://gist.githubusercontent.com/anonymous/9e9588228b0a604264a2/raw/b28be49bea0b7feb859eb65b588c28e9fee5ae2c/map.geojson
    # # Route line
    # mz_route_line:
    #     type: GeoJSON
    #     # sf to ny
    #     url: https://gist.githubusercontent.com/anonymous/30c6c1a75c168d91d90c/raw/92bfe55e622766d250b1f2f5d17bdc7c26acb956/map.geojson
    #     # local sf trip
    #     # url: https://gist.githubusercontent.com/anonymous/9a610ebda6fe4be7bccc/raw/8d217e43f2412d48d01534ba115f1e42dac72e68/map.geojson
    # # Transit route line
    # mz_route_line_transit:
    #     type: GeoJSON
    #     url: https://gist.githubusercontent.com/anonymous/71ae88cbc6d62c4d141ecd6a61060050/raw/2254bbc18243f5dc609e663a580c9412a7447936/map.geojson
    # # Pin at start of route
    # mz_route_start:
    #     type: GeoJSON
    #     url: https://gist.githubusercontent.com/anonymous/5262969cb7549ea69221/raw/be03f233fa323d9b5cf50ef1d8e89a1faa3750f1/map.geojson
    # # Pin at end of route
    # mz_route_destination:
    #     type: GeoJSON
    #     url: https://gist.githubusercontent.com/anonymous/dbae9635dfe46796490e/raw/df55c318635a7d91b309ed40754d4738a292fd38/map.geojson
    # # Arrow for current route location
    # mz_route_location::
    #     type: GeoJSON
    #     url: https://gist.githubusercontent.com/anonymous/36613092be6e2aa004fd/raw/f753d13069425199e1dea1b449ef67d723f6510e/map.geojson
    # # Dots for transit stops in route preview
    # mz_route_transit_stop:
    #     type: GeoJSON
    #     url: https://gist.githubusercontent.com/anonymous/b9f16bca4a804f50faf71277d52ee4ab/raw/db13e4e765fa1ac8844b8ba02f4a0f66fe772907/map.geojson
    # # Pins showing search result locations
    # mz_search_result:
    #     type: GeoJSON
    #     url: https://gist.githubusercontent.com/anonymous/57dc09eeb120919f76de/raw/43426217da3c2bae0522dc4257aaa61e4df3981e/map.geojson
    # # Default point styling (SDK)
    # mz_default_point:
    #     type: GeoJSON
    #     url: https://gist.githubusercontent.com/anonymous/16324c771edfce45be0721390389b878/raw/7dbaebf17da7da8562e6c6f8768bc8cff83efa88/map.geojson
    # # Default line styling (SDK)
    # mz_default_line:
    #     type: GeoJSON
    #     url: https://gist.githubusercontent.com/anonymous/26f4e8b6b34b2617b5d5533d89decb39/raw/df8e180ab4f7f19448014dccc4a755f7cfa20003/map.geojson
    # # Default polygon styling (SDK)
    # mz_default_polygon:
    #     type: GeoJSON
    #     url: https://gist.githubusercontent.com/anonymous/88235c795bb44b8c45150bdd5561f947/raw/71d4fab97b6513833bf1a589167119e6169ef86d/map.geojson
    
cameras:
    isometric:
        type: isometric

styles:

##### LIBRARY OF FUNCTIONS 
#    SPACE functions
    space-tile:
        shaders:
            blocks:
                global: |
                    // Variant to be add to both vertex and fragments shaders
                    varying vec3 v_pos;
                    //
                    // Get the coordinates in tile space
                    // ================================
                    vec2 getTileCoords() {
                        return fract(v_pos.xy);
                    }

                position: |
                    // Normalize the attribute position of a vertex
                    v_pos = modelPosition().xyz;
    space-constant:
        shaders:
            blocks:
                global: |
                    // Get the constant coordinates (glitches on zooms)
                    // ================================
                    vec2 getConstantCoords () {
                        #ifdef TANGRAM_FRAGMENT_SHADER
                        const float pixel_scale = 695.;
                        float meter_pixels = u_meters_per_pixel / u_device_pixel_ratio;
                        vec2 st = gl_FragCoord.xy/pixel_scale;
                        const float dot_wrap = 1000.;
                        st += mod(u_map_position.xy / meter_pixels, dot_wrap)/pixel_scale;
                        return st;
                        #else
                        return vec2(0.0,0.0);
                        #endif
                    }
#    TILING functions
    tiling-tile:
        shaders:
            blocks:
                global: |
                    // Repeats a coordinate space (st) in diferent tiles
                    // ================================
                    vec2 tile(vec2 st, float zoom){
                        st *= zoom;
                        return fract(st);
                    }
    tiling-brick:
        shaders:
            blocks:
                global: |
                    // Repeats a coordinate space (st) in diferent brick-like tiles
                    // ================================
                    vec2 brick(vec2 st, float zoom){
                        st *= zoom;
                        // Here is where the offset is happening
                        st.x += step(1., mod(st.y, 2.0)) * 0.5;
                        return fract(st);
                    }
    tiling-mirror:
        shaders:
            blocks:
                global: |
                    // Mirror the coordinate space 
                    // ================================
                    vec2 mirror(vec2 _st, vec2 _zoom){
                        _st *= _zoom;
                        if (fract(_st.y * 0.5) > 0.5){
                            _st.x = _st.x + 0.5;
                            _st.y = 1.0 - _st.y;
                        }
                        return fract(_st);
                    }             
#    Usefull functions
    functions-aastep:
        shaders:
            extensions: OES_standard_derivatives
            blocks:
                global: |
                    // AntiAliased Step function
                    //=============================
                    float aastep(float threshold, float value) {
                        #ifdef TANGRAM_FRAGMENT_SHADER
                            #ifdef TANGRAM_EXTENSION_OES_standard_derivatives
                                float afwidth = length(vec2(dFdx(value), dFdy(value))) * 0.70710678118654757;
                                return smoothstep(threshold-afwidth, threshold+afwidth, value);
                            #else
                                return step(threshold, value);
                            #endif  
                        #else
                            return step(threshold, value);
                        #endif
                    }
#    Generative functions
    generative-random:
        shaders:
            blocks:
                global: |
                    // 1D Random for 1 and 2 dimentions
                    // ================================
                    float random(float x) { return fract(sin(x)*43758.5453);}
                    float random(vec2 p) { return fract(1e4 * sin(17.0 * p.x + p.y * 0.1) * (0.1 + abs(sin(p.y * 13.0 + p.x)))); }
                    float random(vec3 p) { return fract(sin(dot(p.xyz, vec3(70.9898,78.233,32.4355)))* 43758.5453123); }
                    //
                    // 2D Random for 2 dimentions
                    // ================================
                    vec2 random2 (vec2 xy) { return fract(sin(vec2(dot(xy,vec2(127.1,311.7)),dot(xy,vec2(269.5,183.3))))*43758.5453); }
                    //
                    // 3D Random for 2 dimentions
                    // ================================
                    vec3 random3 (vec2 xy) { return fract(sin(vec3( dot(xy,vec2(127.1,311.7)), dot(xy,vec2(269.5,183.3)), dot(xy,vec2(419.2,371.9)) ))*43758.5453); }
                    vec3 random3 (vec3 c) {
                        float j = 4096.0*sin(dot(c,vec3(17.0, 59.4, 15.0)));
                        vec3 r;
                        r.z = fract(512.0*j);
                        j *= .125;
                        r.x = fract(512.0*j);
                        j *= .125;
                        r.y = fract(512.0*j);
                        return r-0.5;
                    }
#    Drawing Shapes functions
    shapes-circle:
        mix: functions-aastep
        shaders:
            defines:
                PI: 3.14159265358979323846
            blocks:
                global: |
                    // get distance field of a Circle
                    // ================================
                    float circleDF (vec2 st) {
                        return dot(st,st);
                    }
                    //
                    // Draw a circle in the middle of the ST space
                    // ================================
                    float circle (vec2 st, float radius) {
                        return 1.-aastep(radius, circleDF(st-vec2(0.5))*PI);
                    }
    shapes-rect:
        shaders:
            blocks:
                global: |
                    // get distance field of a rectangle in the center
                    // ================================
                    float rectDF(vec2 st, vec2 size) {
                        //float aspect = u_resolution.x/u_resolution.y;
                        st = st*2.-1.;
                        //st.x *= aspect;
                        return length(max(abs(st)-size,.0));
                    }
                    float rectDF(vec2 st, float size) {
                        //float aspect = u_resolution.x/u_resolution.y;
                        st = st*2.-1.;
                        //st.x *= aspect;
                        return length(max(abs(st)-size,.0));
                    }
                    
                    // Draw a round corners rectangle in the center
                    // ================================
                    float rect(vec2 st, vec2 size, float radio) {
                        radio = max(.000001, radio);
                        return 1.0-step(radio, rectDF(st, size-radio));
                    }
                    
                    float rect(vec2 st, float size, float radio) {
                        return rect(st,vec2(size),radio);
                    }
                    
                    // Draw a rectangle in the center
                    // ================================
                    float rect(vec2 st, vec2 size){
                        size = .25-size*.125;
                        vec2 uv = step(size,st*(1.0-st));
                        return (uv.x*uv.y);
                    }
                    
                    float rect(vec2 st, float size){
                        return rect(st,vec2(size));
                    }
#    Patterns compositions functions
    patterns-stripes:
        mix: functions-aastep
        shaders:
            defines:
                PI: 3.14159265358979323846
            blocks:
                global: |
                    // Return a distance function of stripes
                    float stripesDF (vec2 st) {
                        return abs(sin(st.y*PI));
                    }
                    
                    // Adjustable width stripes
                    float stripes (vec2 st, float width) {
                        return aastep(width,stripesDF(st));
                    }
                    
                    // Faster optimisation of diagonal stripes
                    float diagonalStripes (vec2 st) {
                        vec2 i_st = floor(st);
                        vec2 f_st = fract(st);
                        if (mod(i_st.y,2.) - mod(i_st.x,2.) == 0.) {
                            return 1.0 - aastep(f_st.x,f_st.y);
                        } else {
                            return aastep(f_st.x,f_st.y);
                        }
                    }
    patterns-dots:
        mix: [space-tile, tiling-brick, shapes-circle]
        shaders:
            blocks: 
                global: |
                    // Interpolated dot patern between zooms attached to tile coords
                    float TileDots(float scale, float size) {
                        // Beginning of the transition
                        vec2 IN = brick(getTileCoords()*scale,2.);
                        float A = circleDF(vec2(0.5)-IN)*1.8;
                        //
                        // If over 18. add an end B to transition with
                        float d = 0.0;
                        if (u_map_position.z < 18.) {
                            vec2 OUT = fract(getTileCoords()*scale*2.);
                            float B = circleDF(vec2(0.25)-OUT)*5.;
                            B = min(B, circleDF(vec2(0.75,0.25)-OUT)*5.);
                            B = min(B, circleDF(vec2(0.5,0.75)-OUT)*5.);
                            B = min(B, circleDF(vec2(0.,0.75)-OUT)*5.);
                            B = min(B, circleDF(vec2(1.,0.75)-OUT)*5.);
                            d = mix(A, B, pow(fract(u_map_position.z),10.));
                        } else {
                            d = A;
                        }
                        //
                        // Use the antialias step to make a shape from the DF
                        return aastep(size,d);;
                    }
##### ACTUAL STYLES
    dashedline:
        base: lines
        mix: tiling-mirror
        lighting: false # ignore lights
        texcoords: true
        shaders:
            blocks:
                global: |
                    float stripes(vec2 st){
                        st = st * 10.;
                        return step(.5, 1.0 - smoothstep(.3, 1., abs(sin(st.y * 3.14159))));
                    }
                color: |
                    vec2 st = v_texcoord;
                    vec4 foreground = vec4(0.850,0.850,0.850,1.0);
                    color = mix(v_color, foreground, stripes(st));    
    water-gradient:
        base: polygons
        shaders:
            blocks:
                filter: |
                    color.rgb = mix(vec3(1.0), vec3(0.970), gl_FragCoord.x / u_resolution.x + gl_FragCoord.y / u_resolution.y); 

    pixel-pattern-light:
        mix: [space-tile, generative-random]
        base: polygons
        shaders:
            blocks:
                filter: |
                    vec3 pos = vec3(getTileCoords()*130.0,1.0);
                    color.rgb = vec3(random(abs(floor(pos)))+0.785);

    pixel-pattern-bright:
        mix: [space-tile, generative-random]
        base: polygons
        shaders:
            blocks:
                filter: |
                    vec3 pos = vec3(getTileCoords()*180.0,1.0);
                    color.rgb = vec3(random(abs(floor(pos)))+0.855);

    pixel-pattern-dark:
        mix: [space-tile, generative-random]
        base: polygons
        shaders:
            blocks:
                filter: |
                    vec3 pos = vec3(getTileCoords()*280.0,1.0);
                    color.rgb = vec3(random(abs(floor(pos)))+0.695);

    waves:
        base: polygons
        mix: [space-constant, patterns-stripes]
        shaders:
            defines:
                COLOR1: vec3(0.915)
                COLOR2: vec3(0.950)
            blocks:
                global: |
                    float stripes2(vec2 st){
                        return step(.3,1.0-smoothstep(.5,1.,abs(sin(st.y*3.14159265358))));
                    }
                filter: |
                    vec2 st = getConstantCoords();

                    const float wave_width = 30.0;
                    const float wave_height = .01;
                    st.y += sin(st.x*wave_width)*wave_height;

                    // gradient
                    color.rgb = mix(COLOR1, color.rgb, gl_FragCoord.x / u_resolution.x);
                    color = mix(color,vec4(COLOR2,1.0),stripes(st*92.,.5))*1.0;

    waves2:
        base: polygons
        mix: waves
        shaders:
            defines:
                COLOR1: vec3(0.840)
                COLOR2: vec3(0.910)


    stream-waves:
        base: lines
        mix: waves
        shaders:
            defines:
                COLOR1: vec3(0.910)
                COLOR2: vec3(0.980)

    coast:
        base: lines
        mix: [space-constant]
        blend: overlay
        shaders:
            blocks:
                global: |
                    mat2 rotate2d(float angle){
                        return mat2(cos(angle),-sin(angle),
                                    sin(angle),cos(angle));
                    }
                    
                    float stripes(vec2 st){
                        st = rotate2d(3.14159265358*-0.25 )*st;
                        //return step(.9,1.0-smoothstep(.5,1.,abs(sin(st.x*3.14159265358))));
                        return step(.75,1.0-smoothstep(.75,1.,abs(sin(st.x*3.14159265358)))); // more spaced out stripes?
                    }
                color: |
                    vec2 st = getConstantCoords();
                    color = mix(vec4(color.rgb, 0.9), vec4(0.0), stripes(st*130.))*.8; // transparent stripes
                    
    dots:
        mix: [space-tile, tiling-tile, shapes-circle]
        base: polygons
        shaders:
            defines:
                PATTERN_SCALE: 50.0
                DOT_SIZE: .1
                COLOR1: vec3(1.00,1.00,1.00)
                COLOR2: color.rgb  
            blocks:
                color: |
                    vec2 st = getTileCoords();
                    st = tile(st,PATTERN_SCALE);
                    float dot_size = DOT_SIZE;
                    float b = circle(st, dot_size);
                    color *= vec4(b);
                filter: |
                    color.rgb = mix(COLOR1, COLOR2, b);

    dots-medium:
        mix: dots
        base: polygons
        shaders:
            defines:
                PATTERN_SCALE: 60.0
                DOT_SIZE: .25
    dots3:
        mix: dots
        base: polygons
        shaders:
            defines:
                PATTERN_SCALE: 70.0
                DOT_SIZE: .125

    park-dots1:
        mix: dots
        shaders:
            defines:
                COLOR1: vec3(1.00,1.00,1.00)
                COLOR2: color.rgb

    medium-dots:
        mix: dots-medium
        shaders:
            defines:
                COLOR1: vec3(1.00,1.00,1.00)
                COLOR2: color.rgb

    tiny-dots:
        mix: dots3
        shaders:
            defines:
                COLOR1: vec3(1.00,1.00,1.00)
                COLOR2: color.rgb                

    park-dots3:
        mix: dots
        shaders:
            defines:
                COLOR1: vec3(1.00,1.00,1.00)
                COLOR2: vec3(0.760,0.760,0.760)

    dots-rev:
        base: polygons
        mix: patterns-dots
        shaders:
            blocks:
                color: |
                    color.rgb = mix(vec3(1.000), color.rgb, TileDots(35.0, 0.31));

    horizontal-bars:
        base: polygons
        mix: [space-constant, shapes-rect]
        texcoords: false
        shaders:
            blocks:
                global: |
                    float bar(in vec2 st, float size){
                        return  rect(st, vec2(size*0.90,size*0.2));
                    }
                filter: |
                    vec2 pos = getConstantCoords()*50.0;
                    float pct = clamp(bar(fract(pos),0.5),0.0,1.0);
                    color.rgb = mix(vec3(1.0,1.0,1.0),color.rgb,pct);

    horizontal-bars-rev:
        base: polygons
        mix: [space-constant, shapes-rect]
        texcoords: false
        shaders:
            blocks:
                global: |
                    float bar(in vec2 st, float size){
                        return rect(st, vec2(size*1.05,size*0.5));
                    }
                filter: |
                    vec2 pos = getConstantCoords()*50.0;
                    float pct = clamp(bar(fract(pos),0.5),0.0,1.0);
                    color.rgb = mix(color.rgb,vec3(1.0,1.0,1.0),pct);

    # HSV/RGB functions
    hsv:
        shaders:
            blocks:
                global: |
                    vec3 rgb2hsv(vec3 c)
                    {
                        vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
                        vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
                        vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
                        float d = q.x - min(q.w, q.y);
                        float e = 1.0e-10;
                        return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
                    }
                    vec3 hsv2rgb(vec3 c)
                    {
                        vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
                        vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
                        return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
                    }

    scale-buildings:
        shaders:
            blocks:
                position: |
                    // scale buildings based on zoom
                    float zoom = u_map_position.z;
                    float min = .1;       // minimum building scale
                    float midpoint = 16.; // middle of zoom range
                    float inspeed = .1;   // number of zooms to scale buildings up
                    float outspeed = 2.;  // number of zooms to scale buildings back down
                    float e = 0.;

                    if (zoom >= midpoint) {
                        e = (zoom - midpoint) / (outspeed * .2);
                    } else {
                        e = abs(zoom - midpoint) / inspeed;
                    }
                    position.z *= ((1. - min) / (1. + (exp(e)))) + min;

    building-grid:
        base: polygons
        mix: [hsv, scale-buildings]
        texcoords: true
        material:
            diffuse:
                texture: building-grid
                mapping: uv
        shaders:
            defines:
                WALL_TINT: vec3(1., 3., .993) # modifies roof color HSV
            blocks:
                filter: |
                    if (dot(vec3(0., 0., 1.), worldNormal()) < 1.0 - TANGRAM_EPSILON) {
                        // If it's a wall
                        vec3 wall = hsv2rgb(
                            rgb2hsv(v_color.rgb) * WALL_TINT
                        );
                        color.rgb = mix(color.rgb, wall, 1. - color.a);
                        // turn wall opaque, alpha was used to blend w/wall color,
                        // but we don't want the wall itself to be transparent
                        color.a = 1.;
                    } else {
                        // it's a roof, use vertex color without texture
                        color = v_color;
                    }
    sand:
        base: polygons
        mix: [generative-random, space-tile]
        animated: false
        shaders:
            blocks:
                color: |
                    // vec2 st = getTileCoords()*2.;
                    vec2 st = floor(getTileCoords()*250.);
                    color.rgb = mix(vec3(0.75), vec3(1.0), smoothstep(0.048,0.120, random(st)));
    building-lines:
        base: lines
        mix: scale-buildings
        texcoords: true
    lines_transparent:
        base: lines
        blend: overlay
    outline_transparent:
        base: lines
        blend: overlay
    polygons_transparent:
        base: polygons
        blend: overlay
    icons:
        base: points
        texture: pois
        blend_order: 1
    text-blend-order:
        base: text
        blend_order: 1
    ux-lines-overlay:
        base: lines
        blend: overlay
        blend_order: 0
    ux-transit-line-overlay:
        base: lines
        blend: overlay
        blend_order: 0
    ux-location-gem-overlay:
        base: points
        texture: pois
        interactive: true
        blend: overlay
        blend_order: 2
    ux-icons-overlay:
        base: points
        texture: pois
        interactive: true
        blend: overlay
        blend_order: 3
    sdk-point-overlay:
        base: points
        texture: pois
        interactive: true
        blend: overlay
        blend_order: 3
    sdk-line-overlay:
        base: lines
        blend: overlay
        blend_order: 0
    sdk-polygon-overlay:
        base: polygons
        blend: overlay
        blend_order: 0

scene:
    background:
        color: *scene1

layers:
    # Map overlays for styling the server response (using special source layer names) for route line, current location, and search result pins
    mz_route_line:
        data: { source: mz_route_line }
        draw:
            ux-lines-overlay:
                color: '#06a6d4'
                order: 500
                width: [[0,3.5px],[5,5px],[9,7px],[10,6px],[11,6px],[13,8px],[14,9px],[15,10px],[16,11px],[17,12px],[18,10px]]
    mz_route_line_transit:
        data: { source: mz_route_line_transit }
        draw:
            ux-transit-line-overlay:
                # each transit route segment could be a different "line" each with it's own color
                # but some transit lines don't define a color, in those cases default to blue
                # and since the color is coming from Transit.land they call it "color" instead of "colour"
                color: function() { return feature.color || '#06a6d4'; }
                order: 500
                width: [[0,3.5px],[5,5px],[9,7px],[10,6px],[11,6px],[13,8px],[14,9px],[15,10px],[16,11px],[17,12px],[18,10px]]


    mz_current_location_gem:
        data: { source: mz_current_location }
        draw:
            ux-location-gem-overlay:
                interactive: true
                sprite: ux-current-location
                size: 36px
                collide: false
                transition:
                    [show, hide]:
                        time: 0s
    mz_route_location:
        data: { source: mz_route_location }
        draw:
            ux-location-gem-overlay:
                interactive: true
                sprite: ux-route-arrow
                size: [60px,60px]
                collide: false
                transition:
                    [show, hide]:
                        time: 0s
    mz_route_start:
        data: { source: mz_route_start }
        draw:
            ux-icons-overlay:
                interactive: true
                priority: 1
                sprite: ux-route-start
                size: [36px,46px]
                collide: false
                anchor: top
                transition:
                    [show, hide]:
                        time: 0s
    mz_route_destination:
        data: { source: mz_route_destination }
        draw:
            ux-icons-overlay:
                interactive: true
                priority: 1
                sprite: ux-route-stop
                size: [36px,46px]
                collide: false
                anchor: top
                transition:
                    [show, hide]:
                        time: 0s
    mz_route_transit_stop:
        data: { source: mz_route_transit_stop }
        draw:
            ux-icons-overlay:
                interactive: true
                sprite: ux-transit-stop
                size: [15px,15px]
                collide: false
                transition:
                    [show, hide]:
                         time: 0s
    mz_search_result:
        data: { source: mz_search_result }
        draw:
            ux-icons-overlay:
                interactive: true
                sprite: ux-search-active
                size: [36px,54px]
                collide: false
                anchor: top
                transition:
                    [show, hide]:
                        time: 0s
        inactive:
            filter: { state: inactive }
            draw:
                ux-icons-overlay:
                    sprite: ux-search-inactive
    mz_dropped_pin:
        data: { source: mz_dropped_pin }
        draw:
            ux-icons-overlay:
                interactive: true
                sprite: ux-search-active
                size: [36px,54px]
                collide: false
                anchor: top
                transition:
                    [show, hide]:
                        time: 0s
                        
    # Used by the SDK to place point, line, and polygon overlays on the map
    mz_default_point:
        data: { source: mz_default_point }
        draw:
            sdk-point-overlay:
                interactive: true
                sprite: ux-search-active
                size: [36px,54px]
                collide: false
                anchor: top
                transition:
                    [show, hide]:
                        time: 0s
    mz_default_line:
        data: { source: mz_default_line }
        draw:
            sdk-line-overlay:
                color: '#06a6d4'
                order: 503
                width: 3px
    mz_default_polygon:
        data: { source: mz_default_polygon }
        draw:
            sdk-polygon-overlay:
                color: [0.02,0.65,0.82,0.5]  #'#06b1e2'
                order: 501
            sdk-line-overlay:
                color: '#06a6d4'
                order: 502
                width: 0px


    # Basemap styling
#    earth:
#        data: { source: osm, layer: earth }
#        draw:
#            polygons:
#                order: function() { return feature.sort_key; }
#                color: [1.0,1.0,1.0]

#    water:
#        data: { source: osm, layer: water }
#        draw:
#            waves:
#                interactive: true
#                order: function() { return feature.sort_key; }
#                color: [0.880, 0.880, 0.880]
#        later:
#            filter: { $zoom: { min: 12 } }
#            draw:
#                waves2:
#                    color: [0.780, 0.780, 0.780]
#                    order: function() { return feature.sort_key + 1; }

        lakes:
            filter: 
                all:
                    - kind: [ocean, lake, water, riverbank, reservoir, swimming_pool]
                any:
                    # limit show smaller landuse areas to higher zooms
                    - { $zoom: { min: 1 },  area: { min: 40000000000 } }
                    - { $zoom: { min: 2 },  area: { min: 20000000000 } }
                    # some weird natural earth scale set transition
                    - { $zoom: { min: 3 },  area: { min: 80000000000 } }
                    - { $zoom: { min: 4 },  area: { min: 5000000000 } }
                    - { $zoom: { min: 5 },  area: { min: 700000000 } }
                    - { $zoom: { min: 6 },  area: { min: 500000000 } }
                    - { $zoom: { min: 7 },  area: { min: 160000000 } }
                    - { $zoom: { min: 8 },  area: { min: 40000000 } }
                    - { $zoom: { min: 9 },  area: { min: 10000000 } }
                    - { $zoom: { min: 10 }, area: { min: 8000000 } }
                    - { $zoom: { min: 11 }, area: { min: 2000000 } }
                    - { $zoom: { min: 12 }, area: { min: 200000 } }
                    - { $zoom: { min: 13 }, area: { min: 100000 } }
                    - { $zoom: { min: 14 }, area: { min: 2000 } }
                    - { $zoom: { min: 15 } }
            draw:
                waves:
                    color: [0.880, 0.880, 0.880]

        other-water-areas:
            filter: { not: { kind: [ocean, lake, water, reservoir, playa] }, $zoom: { min: 11 }, area: { min: 100 } }
            draw:
                waves:
                    color: [0.880, 0.880, 0.880]
        playas:
            filter: { kind: playa, $zoom: {min: 6} }
            draw:
                waves:
                    color: [0.880, 0.880, 0.880]
        swimming_pool:
            filter: { kind: swimming_pool }
            draw:
                waves:
                    color: [0.880, 0.880, 0.880]
        water-boundary-ocean-early:
            filter: { boundary: yes, kind: ocean, $zoom: {min: 1, max: 17} }
            draw:
                coast:
                    order: function() { return feature.sort_key; }
                    color: [[1,[0.70,0.70,0.70]],[5,[0.60,0.60,0.60]],[6,[0.50,0.50,0.50]]]
                    width: [[2, 1.0px],[6, 1px], [7, 2px],[10, 2px], [14, 2px]]
                    join: round
        water-boundary-ocean-late:
            filter: { boundary: yes, kind: ocean, $zoom: {min: 17} }
            draw:
                coast:
                    order: function() { return feature.sort_key; }
                    color: [0.661, 0.661, 0.661]
                    width: [[14, 4px],[17, 4px],[20, 10px]]
                    join: round
        water_boundaries-not-ocean:
            filter: { boundary: yes, not: { kind: ocean }, $zoom: { min: 8 } }
            draw:
                coast:
                    order: function() { return feature.sort_key; }
                    color: [[6, [0.900, 0.900, 0.900]], [10, [0.761, 0.761, 0.761]],[11,[0.50,0.50,0.50]]]
                    width: [[6,0.75px], [10,1.0px], [14,2.0px], [15,2.0px], [16,3.0px]]
                    join: round
            early:
                filter: { $zoom: { min: 14 } }
                draw:
                    lines:
                        order: 241
            swimming-pools-early:
                filter: { kind: swimming_pool, $zoom: { max: 19 } }
                draw:
                    coast:
                        visible: false
            riverbank:
                # river boundaries like the thames in london, la seine in paris
                filter: { kind: riverbank }
                draw:
                    coast:
                        color: [0.200, 0.200, 0.200]
                        width: [[9,0.5px],[10,0.75px],[11,1px],[14,1px],[15,2px],[17,2px]]
        river:
            #river center lines, not boundaries for polygons
            filter: { kind: [river,canal,stream,dam,ditch,drain], $zoom: { min: 14 }, not: { is_tunnel: true } }
            draw:
                stream-waves:
                    order: function() { return feature.sort_key; }
                    interactive: true
                    color: [0.840,0.840,0.840]
                    width: [[14,0.5px],[15,2.0px],[17,6.0px],[18,8.0px]]
                    cap: round

    subway-light-rail:
        data: { source: osm, layer: transit }
        filter: { not: { kind: [platform] }, $zoom: { min: 14 } }
        draw:
            lines:
                interactive: true
                order: function() { return feature.sort_key || 275; }
        railway:
            filter: { kind: [railway,train] }
            draw:
                lines: 
                    color: [0.70,0.70,0.70]
                    width: [[14,0.5px],[16,1px],[18,1px]]
        subway:
            filter: { kind: subway }
            draw:
                lines: 
                    color: [0.70,0.70,0.70]
                    width: [[14,0.5px],[16,1px],[18,1px]]
        light_rail:
            filter: { kind: [light_rail,tram], $zoom: { min: 15 } }
            draw:
                lines:
                    order: 415
                    color: [0.70,0.70,0.70]
                    width: [[14,0px],[15,0.6px],[16,1px],[17,1px]]

    railway-late:
        data: { source: osm, layer: roads }
        filter: { kind: rail, not: { railway: [subway,light_rail,tram] } }
        draw:
            lines:
                interactive: true
                color: [[14,'#bbb'],[16,'#999']]
                width: [[12,0px],[13,0.25px],[14,0.4px],[15,0.75px],[16,0.75px],[18,1px]]
                # let roads sort themselves past zoom 14
                order: function() { return feature.sort_key; }
                # but give them all the same outline
                outline:
                    order: 354
        bridges-tunnels:
            filter: { any: [is_bridge: yes, is_tunnel: yes] }
            draw:
                lines:
                    outline:
                        # except bridges and tunnels, their outlines should also self-sort
                        order: function() { return feature.sort_key || 305; }
        service:
            filter: { service: true }
            draw:
                lines:
                    color: [0.70,0.70,0.70]
                    width: [[14,0px],[15,0.5px],[16,0.75px],[17,1px],[18,1px]]
    # platforms:
    #     data: { source: osm, layer: transit }
    #     filter: { kind: platform }
    #     draw:
    #         lines_transparent:
    #             color: [0.569,0.690,0.722,0.5]
    #             width: 5m
    #             visible: *grey9_v
    #     polygon_geom:
    #         filter: { $geometry: polygon }
    #         draw:
    #             polygons_transparent:
    #                 color: [0.592,0.671,0.694,0.5]
    #                 visible: *grey9_v
    #             lines_transparent:
    #                 visible: false
    #             outline_transparent:
    #                 color: *grey9_o
    #                 width: [[15,0px],[16,0.5px],[17,1px],[19,2px]]
    #     z-order:
    #         draw:
    #             lines_transparent:
    #                 order: function() { if($zoom<17) { return 10; } else { return 100; } }
    #             polygons_transparent:
    #                 order: function() { if($zoom<17) { return 10; } else { return 100; } }
    #             outline_transparent:
    #                 order: function() { if($zoom<17) { return 11; } else { return 101; } }

    roads:
        data: { source: osm, layer: roads }
        filter: { not: { kind: rail } }
        draw:
            lines:
                interactive: true
                #color: black
                width: 1px
                order: function() { return feature.sort_key; }
                # but give them all the same outline
                outline:
                    order: 352
            text-blend-order:
                visible: false    # labels are enabled by each layer below
                font:
                    family: *text_font_family
                    weight: 500
                    fill: *text_fill

        early:
            filter: { $zoom: { max: 15 } }
            draw:
                lines:
                    outline:
                        order: function() { return feature.sort_key; }
        bridges-tunnels:
            filter: { any: [is_bridge: yes, is_tunnel: yes] }
            draw:
                lines:
                    #cap: butt
                    outline:
                        # except bridges and tunnels, their outlines should also self-sort
                        order: function() { return feature.sort_key; }

        # default outlines starting at zoom 16
        default-outline-width:
            filter: { $zoom: { min: 16 } }
            draw:
                lines:
                    outline:
                        width: function () { return 3/16 * Math.log($zoom); }

        natural_earth_highways:
            filter: { source: 'naturalearthdata.com' }
            draw:
                lines:
                    color: [[5, [0.5,0.5,0.5]],[6, black]]
                    width: [[5, 0.5px], [6, 0.5px], [7, 0.75px], [9, 1.5px], [14, 1.5px], [16, 4px], [17, 10m]]
                    outline:
                        color: *highway_casing1
                        width: [[9, 0px], [10, 0px], [12, 1px], [16, 2px]]
            major_road:
                filter: { type: ['Secondary Highway','Road'] }
                draw:
                    lines:
                        color: [[5, [0.75,0.75,0.75]], [8, [0.4,0.4,0.4]], [13, [0.4,0.4,0.4]], [17, *major_road1]]
                        #color: red
                        width: [[5, 0.25px], [7, 0.5px], [7, 0.75px], [9, 1px], [10, 9px], [11, 9px], [13, 1px], [16, 2.5px], [19, 6m]]
                        outline:
                            width: [[8, 0.0px], [9, 0.0px], [11, .5px], [16, .75px]]
            minor_road:
                filter: { type: 'Unknown' }
                draw:
                    lines:
                        color: [[12, *minor_road1], [17, *minor_road2]]
                        width: [[12, 1.0px], [14, 1.5px], [15, 3px], [16, 5m]]
                        outline:
                            width: [[12, 0px], [14, .5px], [17, 1px]]
            ferry:
                filter: { kind: Ferry }
                draw:
                    lines:
                        color: *ferry1
                        width: [[12, 0.5px], [13, 0.75px], [15, 1.0px]]
                        outline:
                            width: 0px
        highway:
            filter: { kind: highway }
            draw:
                lines:
                    color: [[8, [0.0,0.0,0.0]], [15, [0.0,0.0,0.0]], [16, [1.0,1.0,1.0]]]
                    width: [[8, 1px], [12, 1px], [14, 1.75px], [15, 3px], [16, 3px], [17, 5px], [18, 4m], [19, 5m]]
                    outline:
                        color: [[8, [1.0,1.0,1.0]], [15, [1.0,1.0,1.0]], [16, [0.00,0.00,0.00]]]
                        width: [[8,0px], [15,0px], [16, 3px], [17, 4px], [18, 5px], [19, 6px]]
            link:
                filter: { is_link: yes } # on- and off-ramps, etc
                draw:
                    lines:
                        #color: *highway_link1
                        color: [[9, [0.0,0.0,0.0]], [15, [0.0,0.0,0.0]], [16, [1.0,1.0,1.0]]]
                        width: [[9, 0px], [11, 0.15px], [12, 0.5px], [13, 0.75px], [14, 0.75px], [15, 1.5px], [16, 2px], [17, 2px], [18, 4px], [19, 8px]]
                        outline:
                            color: [[9,[1.0,1.0,1.0]], [15,[1.0,1.0,1.0]], [16,[0.00,0.00,0.00]]]
                            width: [[9, 0px], [15, 0px], [16, 1px], [17, 1px], [18, 2px]]
                early_link:
                    filter: { $zoom: {min: 13, max: 15} }
                    draw:
                        lines:
                            order: 352
                tunnel-link:
                    filter: {is_tunnel: yes, $zoom: {min: 13} }
                    draw:
                        lines:
                            color: [[13,*highway_tunnel1], [14,*highway_tunnel1], [15,[0.8,0.8,0.8]], [16,[0.970,0.970,0.970]]]
                            outline:
                                color: [[13, *highway_tunnel_casing1], [15, *highway_tunnel_casing1], [16, [0.80,0.80,0.80]]]
                                width: [[9, 0px], [15, 0px], [16, 1px], [17, 1px], [18, 2px]]
            tunnel:
                filter: {is_tunnel: yes, $zoom: {min: 13} }
                draw:
                    lines:
                        color: [[13,*highway_tunnel1], [14,*highway_tunnel1], [15,[0.8,0.8,0.8]], [16,[0.950,0.950,0.950]]]
                        outline:
                            color: [[13, *highway_tunnel_casing1], [15, *highway_tunnel_casing1], [16, [0.85,0.85,0.85]]]
                            width: [[8,0px], [15,0px], [16, 3px], [17, 4px], [18, 5px], [19, 6px]]
            highway_bridge:
                filter: {is_bridge: yes}
                draw:
                    lines:
                        cap: round
                        outline:
                            cap: butt
            labels-highway-early:
                filter: { $zoom: [7,8,9] }
                draw:
                    text-blend-order:
                        priority: 50
                        visible: *text_visible_shields
                        text_source: ref
                        font:
                            fill: [0.35,0.35,0.35]
                            weight: 400
                            size: 9px
                            stroke: { color: [1.0,1.0,1.0], width: 4 }
            labels-highway-z10:
                filter:
                    $zoom: 10
                draw:
                    text-blend-order:
                        visible: *text_visible_shields
                        text_source: ref
                        font:
                            fill: [0.25,0.25,0.25]
                            weight: 400
                            size: 9px
                            stroke: { color: [1.0,1.0,1.0], width: 4 }
            labels-highway-z11:
                filter:
                    $zoom: 11
                draw:
                    text-blend-order:
                        visible: *text_visible_shields
                        text_source: ref
                        font:
                            fill: [0.25,0.25,0.25]
                            weight: 600
                            size: 10px
                            stroke: { color: [1.0,1.0,1.0,0.75], width: 4 }
            labels-highway-z12:
                filter:
                    $zoom: 12
                draw:
                    text-blend-order:
                        visible: *text_visible_shields
                        text_source: ref
                        font:
                            fill: *text_fill
                            weight: 600
                            size: 10px
                            stroke: { color: [1.0,1.0,1.0,0.75], width: 4 }
            labels-highway-z13:
                filter:
                    $zoom: 13
                draw:
                    text-blend-order:
                        priority: 50
                        visible: *text_visible_highway
                        #text_source: ref
                        text_source: function() { if( feature.ref && feature.name ) { return feature.ref + " " + feature.name; } else { return feature.name; } }
                        font:
                            fill: *text_fill
                            weight: 600
                            size: 11px
                            stroke: { color: [1.0,1.0,1.0,0.75], width: 4 }
            labels-highway-z14:
                filter:
                    $zoom: 14
                draw:
                    text-blend-order:
                        priority: 50
                        visible: *text_visible_highway
                        #text_source: ref
                        text_source: function() { if( feature.ref && feature.name ) { return feature.ref + " " + feature.name; } else { return feature.name; } }
                        font:
                            fill: *text_fill
                            weight: 600
                            size: 11px
                            stroke: { color: [1.0,1.0,1.0,0.85], width: 4 }
            labels-highway-z15:
                filter:
                    $zoom: 15
                draw:
                    text-blend-order:
                        visible: *text_visible_highway
                        font:
                            fill: [1.0,1.0,1.0]
                            weight: 600
                            size: 12px
                            stroke: { color: [0.0,0.0,0.0], width: 3 }
            labels-highway-z16:
                filter: { $zoom: { min: 16, max: 18 } }
                draw:
                    text-blend-order:
                        priority: 50
                        visible: *text_visible_highway
                        font:
                            fill: [1.0,1.0,1.0]
                            weight: 600
                            size: 13px
                            stroke: { color: [0.0,0.0,0.0], width: 3 }
            labels-highway-z17:
                filter: { $zoom: { min: 17 } }
                draw:
                    text-blend-order:
                        priority: 50
                        visible: *text_visible_highway
                        font:
                            fill: [1.0,1.0,1.0]
                            weight: 600
                            size: 15px
                            stroke: { color: [0.0,0.0,0.0], width: 4 }
            labels-highway-z18:
                filter: { $zoom: { min: 18 } }
                draw:
                    text-blend-order:
                        priority: 50
                        visible: *text_visible_highway
                        font:
                            fill: [1.0,1.0,1.0]
                            weight: 600
                            size: 16px
                            stroke: { color: [0.0,0.0,0.0], width: 4 }
            labels-highway-z19:
                filter: { $zoom: { min: 19 } }
                draw:
                    text-blend-order:
                        priority: 50
                        visible: *text_visible_highway
                        font:
                            fill: [0.0,0.0,0.0]
                            weight: 600
                            size: 16px
                            stroke: { color: [1.0,1.0,1.0], width: 4 }

        pier:
            filter: { kind: path, man_made: pier }
            draw:
                lines:
                    color: [0.993,0.993,0.993]
                    width: [[13, 0px], [14, 0.5px],[15, 1.5px], [16, 2.5px],[17, 3px],[18, 3m]]
                    outline:
                        color: [0.675,0.675,0.675]
                        width: [[15, 0px],[16,0.65px], [17, 0.75px], [18, 1px], [19, 1.5px]]
        racetrack:
            filter: { kind: racetrack }
            draw:
                lines:
                    interactive: true
                    cap: round
                    join: round
                    color: [0.0,0.0,0.0]
                    width: [[13,0.5px],[14,1px],[15, 1px], [16, 1.5px], [18, 3px], [19, 5px]]
        airport-lines:
            filter: { kind: minor_road, aeroway: [runway,taxiway] }
            draw:
                lines:
                    color: [[11, [0.25,0.25,0.25]], [17, [0.0,0.0,0.0]]]
                    cap: butt
                    width: [[10, 1px], [11, 1.5px], [12, 2px], [13, 4px], [14, 8px], [15, 16px], [16, 32px], [17, 60m]]
                    outline:
                        color: [1.0,1.0,1.0]
            # Features come in at zoom 9, but include mostly minor airports without POIs until z13
            early:
                filter: { $zoom: { max: 12 }, not: { landuse_kind: [aerodrome, runway, taxiway] } }
                draw:
                    lines:
                        visible: false
            not-round:
                filter: { $zoom: { min: 17 } }
                draw:
                    lines:
                        cap: butt
            taxiway:
                filter: { aeroway: taxiway }
                draw:
                    lines:
                        color: [[14, [0.75,0.75,0.75]], [15, [0.6,0.6,0.6]], [16, [0.3,0.3,0.3]], [17, [0.0,0.0,0.0]]]
                        width: [[14, 1px], [17, 1.5px], [18, 4m]]
                        outline:
                            width: 0.5px
                            color: [1.0,1.0,1.0]
                early:
                    filter: { $zoom: { max: 13 } }
                    draw:
                        lines:
                            visible: false
        ferry:
            filter: { kind: ferry }
            draw:
                lines:
                    color: [[12, *ferry1], [13, [0.80,0.80,0.80]]]
                    width: [[12, 0.5px], [13, 0.75px], [15, 1.0px]]
        aerialway:
            filter: { kind: aerialway }
            draw:
                lines:
                    interactive: true
                    color: [0.5,0.5,0.5]
                    width: [[14, 0.5px], [15, 1.0px], [16, 2m]]
            gondola_cable_car:
                filter: { aerialway: [gondola, cable_car] }
                draw:
                    lines:
                        color: [0.5,0.5,0.5]
                        width: [[12, 0.5px], [13, 0.5px], [14, 0.6px], [15, 1px], [16, 2px]]
#                    lines_transparent:
#                        color: [0.5,0.5,0.5]
#                        width: [[12, 0px], [13, 5px], [14, 8px], [15, 10px], [16, 12px]]
            chair_lift:
                filter: { aerialway: chair_lift }
                draw:
                    lines:
                        color: [0.5,0.5,0.5]
                        width: [[12, 0.5px], [13, 0.5px], [14, 0.6px], [15, 1px], [16, 1px], [16, 2px], [18, 3m]]
#                    lines_transparent:
#                        color: [0.5,0.5,0.5]
#                        width: [[12, 0px], [13, 5px], [14, 8px], [15, 10px], [16, 12px], [18, 20px]]
            aerialway-labels:
                filter: { $zoom: { min: 14 } }
                draw:
                    text-blend-order:
                        priority: 59
                        visible: *text_visible_aerialway
                        text_source: name
                        font:
                            fill: *text_fill
                            size: 10px
                            stroke: { color: *text_stroke_park, width: 4 }
                minor:
                    filter: { not: { aerialway: [gondola,cable_car,chair_lift] }, $zoom: { max: 17 } }
                    draw:
                        text-blend-order:
                            visible: false
                early_gondola:
                    filter: { $zoom: [14], aerialway: [gondola,cable_car] }
                    draw:
                        text-blend-order:
                            font:
                                weight: 600
                later:
                    filter: { $zoom: { min: 15 } }
                    draw:
                        text-blend-order:
                            font:
                                weight: 600

    buildings:
        data: { source: osm, layer: buildings }
        filter:
            not: { location: underground }
       # set default footprint and extrusion draw properties, but don't draw by default (rules below will turn visibility on)
        draw:
            polygons:
                visible: false
                order: 329
                color: [1.000, 1.000, 1.000]
            lines:
                visible: false
                style: lines
                order: 330
                color: [[14, [0.8,0.8,0.8]], [15, [0.78,0.78,0.78]], [16, [0.67,0.67,0.67]],[17, [0.56,0.56,0.56]],[18, [0.45,0.45,0.45]], [19, [0.37,0.37,0.37]]]
                width: [[14,0.3px],[15,0.5px],[16,0.75px],[18,0.75px],[19,1px]]

        # turn interactive feature selection on for buildings with names
        interactive:
            filter: { name: true }
            draw: { polygons: { interactive: true } }

        # building footprints, pre-extrusion
        footprints:
            filter:
                $zoom: { max: 18 }
                any:
                    # show footprints for buildings at least one zoom level before they will be extruded
                    - { $zoom: [13], area: { min: 50000 } }
                    - { $zoom: [13], height: { min: 250 } }
                    - { $zoom: [13], volume: { min: 200000 } }
                    - { $zoom: [14], area: { min: 5000 } }
                    - { $zoom: [14], height: { min: 190 } }
                    - { $zoom: [14], volume: { min: 150000 } }
                    - { $zoom: [15], height: { min: 100 } }
                    - { $zoom: [15], area: { min: 500 } }
                    - { $zoom: [15], volume: { min: 100000 } }
                    - { $zoom: [16], area: { min: 100 } }
                    - { $zoom: [16], volume: { min: 50000 } }
                    - { $zoom: { min: 17 } }
            draw:
                polygons:
                    visible: true
                lines:
                    visible: true

        # 3d buildings
        extrude:
            filter:
                any:
                    - { $zoom: [15], height: { min: 190 } }
                    - { $zoom: [15], area: { min: 5000 } }
                    - { $zoom: [15], volume: { min: 100000 } }
                    - { $zoom: [16], height: { min: 100 } }
                    - { $zoom: [16], area: { min: 3500 } }
                    - { $zoom: [16], volume: { min: 50000 } }
                    - { $zoom: [17], area: { min: 500 } }
                    - { $zoom: [17], volume: { min: 15000 } }
                    - { $zoom: { min: 18 } }
            draw:
                polygons:
                    visible: true
                    order: 438
                    style: building-grid
                    extrude: function() { return feature.height || 20; }
                    color: [1.0, 1.0, 1.0]
                lines:
                    visible: true
                    order: 439
                    style: building-lines
                    extrude: function() { return feature.height || 20; }

        # landuse-specific rules
        in_park:
            filter: { landuse_kind: [park,forest,nature_reserve,conservation,golf_course,garden] }
            draw:
                polygons:
                    color: [1.0,1.0,1.0]

            # golf_course:
            #     filter: { landuse_kind: golf_course }
            #     draw:
            #         polygons:
            #             color: *building2
            # nature_reserve:
            #     filter: { landuse_kind: nature_reserve }
            #     draw:
            #         polygons:
            #             color: *building2
            # conservation:
            #     filter: { landuse_kind: conservation }
            #     draw:
            #         polygons:
            #             color: *building2
            # zoo:
            #     filter: { landuse_kind: zoo }
            #     draw:
            #         polygons:
            #             color: *building2
        in_university:
            filter: { landuse_kind: [university,school] }
            draw:
                polygons:
                    color: [1.0,1.0,1.0]
        in_hospital:
            filter: { landuse_kind: hospital }
            draw:
                polygons:
                    color: [1.0,1.0,1.0]
        in_airport:
            filter: { landuse_kind: [aerodrome, runway, taxiway] }
            draw:
                polygons:
                    color: [1.0,1.0,1.0]
        in_retail:
           filter: { landuse_kind: retail }
           draw:
                polygons:
                    color: [1.0,1.0,1.0]

    building-labels:
        data: { source: osm, layer: buildings }
        filter:
            all:
                - { $zoom: { min: 16 } }
                - $geometry: point
                - not: { location: underground }
                - kind: [false, building, university, college, school, kindergarten]
            any:
                - { $zoom: [16], area: { min: 5000 }, name: true }
                - { $zoom: [16], area: { min: 5000 }, kind: true }
                - { $zoom: [16], area: { min: 10000 }, landuse_kind: true }
                - { $zoom: [16], area: { min: 7000 }, kind: [university, college, school, kindergarten] }
                - { $zoom: [16], volume: { min: 50000 }, name: true }
                - { $zoom: [17], area: { min: 3000 }, name: true }
                - { $zoom: [17], area: { min: 2000 }, kind: [university, college, school, kindergarten] }
                - { $zoom: [18], area: { min: 1000 }, name: true }
                - { $zoom: [18], kind: [university, college, school, kindergarten] }
                - { $zoom: [19], area: { min: 200 }, name: true }
                - { $zoom: { min: 19 }, kind: [university, college, school, kindergarten] }
                - { $zoom: { min: 20 }, name: true }
        draw:
            text-blend-order:
                interactive: true
                move_into_tile: true
                priority: 51
                order: 7
                # visible: *text_visible_building
                font:
                    fill: [0.300,0.300,0.300]
                    family: *text_font_family
                    style: italic
                    size: 11px
                    stroke: { color: *building2, width: 4 }
        building_labels-z15-z16:
            filter: { $zoom: [15,16] }
            draw: { text-blend-order: { font: { size: 9px, stroke: { width: 3 } } } }
        building_labels-z17-z18:
            filter: { $zoom: [17,18] }
            draw: { text-blend-order: { font: { size: 11px, stroke: { width: 3 } } } }
        building_labels-z19-up:
            filter: { $zoom: [19,20] }
            draw: { text-blend-order: { font: { size: 12px, stroke: { width: 3 }  } } }
        building-labels-z16:
            filter: function() { if( $zoom == 16 && feature.name.length > 20 ) { return true; } else { return false; } }
            draw:
                text-blend-order:
                    visible: false
        building-labels-z17:
            filter: function() { if( $zoom == 17 && feature.name.length > 30 ) { return true; } else { return false; } }
            draw:
                text-blend-order:
                    visible: false
        building-labels-z20+:
            filter: { $zoom: { min: 20 } }
            draw:
                text-blend-order:
                    text_source: function() { if( feature.addr_housenumber ) { return feature.name + '\n' + feature.addr_housenumber; } else { return feature.name; } }
    address-labels:
        data: { source: osm, layer: buildings }
        filter:
            $zoom: { min: 20 }
            any:
                - kind: address
                - { label_position: yes, addr_housenumber: true, name: false }
        draw:
            text-blend-order:
                interactive: true
                order: 7
                visible: *text_visible_address
                text_source: addr_housenumber
                font:
                    fill: *text_fill_address
                    family: *text_font_family
                    style: italic
                    size: 11px
                    stroke: { color: *text_stroke_address, width: 4 }

    boundaries:
        data: { source: osm, layer: boundaries }
        # country subdivisions (states, provinces)
        draw:
            lines:
                interactive: true
                order: function() { return feature.sort_key; }
#                color: red
#                width: [[9, 1px], [14, 2px], [16, 3px], [17, 8m]]
        country:
            filter:
                any:
                    - type: country
                    - kind: nation
                    - admin_level: 2
            draw:
                country-outerline:
                    style: lines
                    order: function() { return (feature.sort_key -1); }
                    color: [[0, [0.70,0.70,0.70]], [6, [0.815,0.815,0.815]]]
                    width: [[0, 0.5px], [2, 0.75px], [5, 1.7px], [6, 3.5px], [7, 4px], [9, 5px], [14, 7px], [16, 8px], [17, 14m]]
                lines:
                    interactive: true
                    color: [1.0,1.0,1.0]
                    width: [[0, 0px], [5, 0px], [6, 1px], [7, 1px], [9, 1px]]
            water:
                filter: { maritime_boundary: yes }
                draw:
                    country-outerline:
                        visible: false
                    lines:
                        visible: false

        region:
            filter:
                any:
                    - type: state
                    # territorial here is probably a hack
                    - kind: [state, department, region, provincial, territorial]
                    - admin_level: 4
            draw:
                lines:
                    interactive: true
                    color: *region_boundary
                    width: [[0, 0.5px], [5, 0.5px], [9, 3.5px], [14, 5.5px], [16, 6.5px], [17, 16m]]
            water:
                filter: { maritime_boundary: yes }
                draw:
                    lines:
                        visible: false
            early:
                filter: { scalerank: [0,3,4,5,6,7,8,9,10], $zoom: { max: 8 } }
                draw:
                    lines:
                        visible: false

#        subregions:
#            filter: { kind: county, $zoom: { min: 10 } }
#            draw:
#                lines:
#                    interactive: true
#                    order: 6
#                    color: *subregion_boundary
#                    width: [[9, 1px], [14, 2px], [16, 3px], [17, 8m]]

        # city_walls:
        #     filter: { kind: city_wall }
        #     draw:
        #         lines:
        #             interactive: true
        #             order: 8
        #             color: *city_wall
        #             width: [[12, 0.75px], [13, 1.0px], [14, 1.2px], [15, 2.0px], [16, 2.5px], [19, 6m]]
        retaining_wall:
            filter: { kind: retaining_wall }
            draw:
                lines:
                    interactive: true
                    color: [0.90,0.90,0.90] # *retaining_wall
                    width: [[14, 0.5px], [15, 1.0px], [16, 1.5px], [17, 2.0px], [19, 4m]]
        # snow_fence:
        #     filter: { kind: snow_fence }
        #     draw:
        #         lines:
        #             interactive: true
        #             order: 8
        #             color: [1.0,0.0,0.0] # *snow_fence
        #             width: [[14, 0.5px], [15, 1.0px], [16, 1.5px], [17, 2.0px], [19, 4m]]

        fence:
            filter: { kind: fence }
            draw:
                lines:
                    interactive: true
                    color: [1.0,1.0,1.0]
                    width: [[14, 0.5px], [15, 1.0px], [16, 1.5px], [17, 2.0px], [19, 1m]]

    places:
        data: { source: osm, layer: places }
        filter: { not: { kind: [ocean, sea] } }
        draw:
            text-blend-order:
                visible: false    # labels are enabled by each layer below
                font:
                    family: *text_font_family
                    # weight: 500
                    fill: *text_fill

        continent:
            filter: { name: true, kind: [continent], $zoom: {max: 5} }
            draw:
                text-blend-order:
                    visible: *text_visible_continent
                    font:
                        size: 14px
                        style: italic
                        fill: *text_fill
                        weight: 600
                        # stroke: { color: *text_stroke, width: 4 }
                        transform: uppercase
        continent-spacer:
            filter: { kind: continent }
            continent-spacer-z1-z5:
                filter: { $zoom: { min: 1, max: 5 } }
                draw:
                    text-blend-order:
                        text_source: function() { return feature.name.split('').join(' ') }
                        text_wrap: false

        country-z2:
            filter:
                all:
                    - kind: [country]
                    - $zoom: [2]
                    - name: ["United States of America","Brasil","中华人民共和国","Россия","Canada","Kalaallit Nunaat","Ísland","Australia","India","日本","Guam","Indonesia","South Africa","مصر","Nigeria","Kenya"]
            draw:
                text-blend-order:
                    priority: 3
                    visible: *text_visible_admin
                    text_source: function() { return feature["name:en"] || feature["name"]; }
                    font:
                        fill: *text_fill
                        weight: 200
                        size: 11px
                        stroke: { color: *text_stroke, width: 4 }
        country-z3:
            filter: { name: true, population: true, kind: [country], $zoom: [3] }
            draw:
                text-blend-order:
                    priority: 3
                    visible: *text_visible_admin
                    text_source: function() { return feature["name:en"] || feature["name"]; }
                    font:
                        fill: *text_fill
                        weight: 200
                        size: 11px
                        stroke: { color: *text_stroke, width: 4 }
    #            icons:
    #                size: [[13, 12px], [15, 18px]]
    #                interactive: true
    #                sprite: *townspot_sprite
            early-ones:
                # US, Brazil, China, Russia, Canada, Greenland, Iceland, Australia, India, Japan, Guam, Indonesia, South Africa, Egypt, Nigeria, Kenya
                filter: { not: { name: ["United States of America","Brasil","中华人民共和国","Россия","Canada","Kalaallit Nunaat","Ísland","Australia","India","日本","Guam","Indonesia","South Africa","مصر","Nigeria","Kenya"] }, $zoom: {min: 3, max: 4} }
                draw:
                    text-blend-order:
                        visible: false
        country-z4:
            filter: { name: true, population: true, kind: [country], $zoom: [4] }
            draw:
                text-blend-order:
                    priority: 3
                    visible: *text_visible_admin
                    text_source: function() { return feature["name:en"] || feature["name"]; }
                    font:
                        fill: *text_fill
                        weight: 200
                        size: 13px
                        stroke: { color: *text_stroke, width: 4 }
    #            icons:
    #                size: [[13, 12px], [15, 18px]]
    #                interactive: true
    #                sprite: *townspot_sprite
            early-ones-z4:
                filter: { name: [Nederland,Luxembourg,Liechtenstein,San Marino,Civitatis Vaticanæ,Crna Gora,Македонија,The Gambia,Burundi,Swaziland,الإمارات العربية المتحدة,العراق,Singapore,El Salvador,Belize,Trinidad and Tobago, Saint Lucia, Montserrat,Anguilla,República Dominicana,Bahamas,British Virgin Islands,Antigua and Barbuda,Grenada,Sint Maarten,Saint Kitts and Nevis,Cayman Islands,België - Belgique - Belgien], $zoom: {min: 4, max: 5} }
                draw:
                    text-blend-order:
                        visible: false
        country-z5:
            filter:
                all:
                    - name: true
                    - population: true
                    - kind: [country]
                    - $zoom: [5]
                any:
                    - { population: { min: 5000000 } }
            draw:
                text-blend-order:
                    priority: 3
                    visible: *text_visible_admin
                    text_source: function() { return feature["name:en"] || feature["name"]; }
                    font:
                        fill: *text_fill
                        weight: 600
                        size: 13px
                        stroke: { color: *text_stroke, width: 4 }
            # country-spacer-z5:
            #     filter: { kind: country, $zoom: [5] }
            #     draw:
            #         text-blend-order:
            #             text_source: function() { return feature.name.split('').join(' ') }
            #             text_wrap: false
    #            icons:
    #                size: [[13, 12px], [15, 18px]]
    #                interactive: true
    #                sprite: *townspot_sprite
            early-ones-z5:
                filter: { name: [Luxembourg,Liechtenstein,San Marino,Civitatis Vaticanæ,El Salvador,Belize,België - Belgique - Belgien], $zoom: {min: 5, max: 6} }
                draw:
                    text-blend-order:
                        visible: false
        country-z6:
            # South Ossetia and Abkhazia aren't countries (they are disputed areas)
            filter: { name: true, kind: [country], $zoom: [6] }
            draw:
                text-blend-order:
                    priority: 3
                    visible: *text_visible_admin
                    text_source: function() { return feature["name:en"] || feature["name"]; }
                    font:
                        size: 14px
                        weight: 600
                        fill: *text_fill
                        stroke: { color: *text_stroke, width: 4 }
            small-ones-z6:
                filter: { name: [Luxembourg,Liechtenstein,San Marino,Civitatis Vaticanæ,België - Belgique - Belgien,Хуссар Ирыстон,Аҧсны - Абхазия], $zoom: {min: 6, max: 7} }
                draw:
                    text-blend-order:
                        visible: false
        country-z7:
            # South Ossetia and Abkhazia aren't countries (they are disputed areas)
            filter: { name: true, kind: [country], $zoom: { min: 7, max: 9 } }
            draw:
                text-blend-order:
                    priority: 3
                    visible: *text_visible_admin
                    text_source: function() { return feature["name:en"] || feature["name"]; }
                    font:
                        size: 16px
                        weight: 600
                        fill: *text_fill
                        stroke: { color: *text_stroke, width: 4 }
            small-ones-z7:
                filter: { name: [Liechtenstein,San Marino,Civitatis Vaticanæ,Хуссар Ирыстон,Аҧсны - Абхазия], $zoom: {min: 7, max: 8} }
                draw:
                    text-blend-order:
                        visible: false

        region-z4:
            filter: { name: true, kind: [state], $zoom: [4], not: { name: ["Western Cape","Eastern Cape","Northern Cape","North West","Limpopo","KwaZulu-Natal","Hamburg","Freie und Hansestadt Hamburg","Neuchâtel","Nordrhein-Westfalen","Haute-Normandie","Baden-Württemberg","Bayern","Sachsen-Anhalt","Berlin","Mecklenburg-Vorpommern","Schleswig-Holstein","Brandenburg","Niedersachsen","Saarland","Thüringen","Hessen","Sachsen"] } }
            draw:
                text-blend-order:
                    priority: 14
                    visible: *text_visible_admin
                    text_source: 'name:short'
                    font:
                        size: 11px
                        weight: 400
                        fill: [0.70,0.70,0.70]
                        stroke: { color: *text_stroke, width: 4 }

        region-z5:
            filter: { name: true, kind: [state], $zoom: [5], not: { name: ["Western Cape","Eastern Cape","Northern Cape","North West","Limpopo","KwaZulu-Natal","Hamburg","Freie und Hansestadt Hamburg","Neuchâtel","Nordrhein-Westfalen","Haute-Normandie","Baden-Württemberg","Bayern","Sachsen-Anhalt","Berlin","Mecklenburg-Vorpommern","Schleswig-Holstein","Brandenburg","Niedersachsen","Saarland","Thüringen","Hessen","Sachsen"] } }
            draw:
                text-blend-order:
                    priority: 14
                    visible: *text_visible_admin
                    text_source: 'name:short'
                    font:
                        size: 18px
                        weight: 200
                        fill: [0.5,0.5,0.5,0.5]
                        stroke: { color: *text_stroke, width: 4 }

        region-z6:
            filter: { name: true, kind: [state], $zoom: [6], not: { name: ["Western Cape","Eastern Cape","Northern Cape","North West","Limpopo","KwaZulu-Natal","Hamburg","Freie und Hansestadt Hamburg","Neuchâtel","Nordrhein-Westfalen","Haute-Normandie","Baden-Württemberg","Bayern","Sachsen-Anhalt","Berlin","Mecklenburg-Vorpommern","Schleswig-Holstein","Brandenburg","Niedersachsen","Saarland","Thüringen","Hessen","Sachsen"] } }
            draw:
                text-blend-order:
                    priority: 14
                    visible: *text_visible_admin
                    text_source: 'name:short'
                    font:
                        size: 21px
                        weight: 200
                        fill: [0.5,0.5,0.5,0.5]
                        # stroke: { color: *text_stroke, width: 4 }
                        transform: uppercase

        region:
            filter: { name: true, kind: [state], $zoom: {min: 7, max: 9} }
            draw:
                text-blend-order:
                    priority: 14
                    visible: *text_visible_admin
                    text_source: function() { if(feature["name:short"]) { return feature["name"]; } else { return ""; } }
                    font:
                        size: 30px
                        weight: 200
                        fill: [0.5,0.5,0.5,0.5]
                        # stroke: { color: *text_stroke, width: 4 }
                        transform: uppercase
    #            icons:
    #                size: [[13, 12px], [15, 18px]]
    #                interactive: true
    #                sprite: *townspot_sprite
            pesky:
                filter: { name: ["Western Cape","Eastern Cape","Northern Cape","North West","Limpopo","KwaZulu-Natal","Hamburg","Freie und Hansestadt Hamburg","Neuchâtel","Nordrhein-Westfalen","Haute-Normandie","Baden-Württemberg","Bayern","Sachsen-Anhalt","Berlin","Mecklenburg-Vorpommern","Schleswig-Holstein","Brandenburg","Niedersachsen","Saarland","Thüringen","Hessen","Sachsen"], $zoom: {min: 7, max: 8} }
                draw:
                    text-blend-order:
                        visible: false
            small-ones:
                filter: { name: ["Delaware","New Jersey","Connecticut","Rhode Island","Massachusetts","New Hampshire","Vermont"], $zoom: {min: 7, max: 8} }
                draw:
                    text-blend-order:
                        text_source: function() { return feature["name:abbreviation"] || feature["name"]; }
                        font: { transform: uppercase }

        populated-places:
            draw:
                icons:
                    interactive: true
                    priority: 5
                text-blend-order:
                    interactive: true
                    anchor: bottom
                    priority: 6
                    # offset: [0, 4px]

            populated-places-natural-earth-z2:
                filter: { name: true, source: naturalearthdata.com, $zoom: [2], scalerank: 0 }
                draw:
                    text-blend-order:
                        visible: *text_visible_populated_places
                        offset: [0, 3px] # half icon size
                        font:
                            size: 10px
                            fill: *text_fill
                            stroke: { color: *text_stroke, width: 4 }
                    icons:
                        size: 5px
                        visible: *icon_visible_populated_places
                        sprite: townspot-s-rev

            populated-places-natural-earth-z3:
                filter: { name: true, source: naturalearthdata.com, $zoom: [3] }
                z3places-1:
                    filter: { scalerank: [0] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            font:
                                size: 11px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                z3places-2:
                    filter: { scalerank: [1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 8
                            font:
                                size: 9px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            priority: 7
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev

            populated-places-natural-earth-z4:
                filter: { name: true, source: naturalearthdata.com, $zoom: [4] }
                z4places-1:
                    filter: { scalerank: [0] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            font:
                                size: 11px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev

                z4places-2:
                    filter: { scalerank: [1,2] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 8
                            font:
                                size: 9px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            priority: 7
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev

            populated-places-natural-earth-z5:
                filter: { name: true, source: naturalearthdata.com, $zoom: [5] }
                z5places-1:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 8
                            font:
                                size: 15px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            priority: 7
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 4px] # half icon size
                                priority: 6
                            icons:
                                priority: 5
                                size: 8px
                                sprite: capital-l

                z5places-2:
                    filter: { scalerank: [2] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 12
                            font:
                                size: 12px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            priority: 11
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 10
                            icons:
                                priority: 9
                                size: 6px
                                sprite: capital-m

                z5places-3:
                    filter: { scalerank: [3,4] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 18
                            font:
                                size: 10px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            priority: 17
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 16
                            icons:
                                priority: 15
                                size: 6px
                                sprite: capital-m

            populated-places-natural-earth-z6:
                filter: { name: true, source: naturalearthdata.com, $zoom: [6] }
                z6places-1:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 4px] # half icon size
                            priority: 8
                            font:
                                size: 16px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            priority: 7
                            size: 8px
                            visible: *icon_visible_populated_places
                            sprite: townspot-l-rev
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 4px] # half icon size
                                priority: 6
                            icons:
                                sprite: capital-l
                                size: 8px
                                priority: 5

                z6places-2:
                    filter: { scalerank: [2,3,4] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 12
                            font:
                                size: 13px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            priority: 11
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 10
                            icons:
                                size: 6px
                                sprite: capital-m
                                priority: 9

                z6places-3:
                    filter: { scalerank: [5,6] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon 
                            priority: 16
                            font:
                                size: 11px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 15
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 14
                            icons:
                                size: 6px
                                sprite: capital-m
                                priority: 13

            populated-places-natural-earth-z7:
                filter: { name: true, source: naturalearthdata.com, $zoom: [7] }
                z7places-1:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 4px] # half icon size
                            priority: 8
                            font:
                                size: 17px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 8px
                            visible: *icon_visible_populated_places
                            sprite: townspot-l-rev
                            priority: 7
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 4px] # half icon size
                                priority: 6
                            icons:
                                size: 8px
                                sprite: capital-l
                                priority: 5

                z7places-2:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 14
                            font:
                                size: 14px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 13
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 4px] # half icon size
                                priority: 12
                            icons:
                                size: 8px
                                sprite: capital-l
                                priority: 11

                z7places-3:
                    filter: { scalerank: [6,7] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 18
                            font:
                                size: 12px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 17
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 16
                            icons:
                                size: 6px
                                sprite: capital-m
                                priority: 15

            populated-places-osm-z8:
                filter:
                    all:
                        - source: [openstreetmap, openstreetmap.org]
                        - name: true
                        - population: true
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [8]

                z8places-1:
                    filter:
                        any:
                            - { population: { min: 1000000 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 8
                            font:
                                size: 17px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 7
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 4px] # half icon size
                                priority: 6
                            icons:
                                size: 8px
                                sprite: capital-l
                                priority: 5
                z8places-2:
                    filter:
                        any:
                            - { population: { min: 150000, max: 999999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 12
                            font:
                                size: 14px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 11
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 10
                            icons:
                                size: 6px
                                sprite: capital-m
                                priority: 9

                z8places-3:
                    filter:
                        any:
                            - { population: { min: 85000, max: 149999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 16
                            font:
                                size: 12px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 15
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 14
                            icons:
                                size: 6px
                                sprite: capital-m
                                priority: 13

                z8places-4:
                    filter:
                        any:
                            - { population: { min: 50000, max: 84999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 20
                            font:
                                size: 10px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 19
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 18
                            icons:
                                size: 5px
                                sprite: capital-m
                                priority: 17
                z8places-5:
                    filter:
                        all:
                            - { population: { max: 50000 } }
                        any:
                            - { capital: yes }
                            - { state_capital: yes }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 20
                            font:
                                size: 10px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 19
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 3px] # half icon size
                                priority: 18
                            icons:
                                size: 5px
                                sprite: capital-s
                                priority: 17
                                    
            populated-places-natural-earth-z8-backfill:
                filter: { name: true, source: naturalearthdata.com, $zoom: [8], population: { max: 50000 } }
                draw: { text-blend-order: { font: { fill: *text_fill } } }
                z8places-1-ne:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 4px] # half icon size
                            priority: 24
                            font:
                                size: 17px
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 8px
                            visible: *icon_visible_populated_places
                            sprite: townspot-l-rev
                            priority: 23
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                offset: [0, 4px] # half icon size
                                priority: 22
                            icons:
                                size: 8px
                                sprite: capital-l
                                priority: 21

                z8places-2-ne:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            font:
                                size: 14px
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                    capital:
                        filter: { capital: yes }
                        draw:
                            icons:
                                sprite: capital-m

                z8places-3-ne:
                    filter: { scalerank: [6,7] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 28
                            font:
                                size: 10px
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 27
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 26
                            icons:
                                sprite: capital-s
                                priority: 25

            populated-places-osm-z9:
                filter:
                    all:
                        - source: [openstreetmap, openstreetmap.org]
                        - name: true
                        - population: true
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [9]

                z9places-1:
                    filter:
                        any:
                            - { population: { min: 1000000 } }
                    draw:
                        text-blend-order:
                            anchor: center
                            visible: *text_visible_populated_places
                            priority: 6
                            font:
                                size: 17px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }

                z9places-2a:
                    filter:
                        any:
                            - { population: { min: 350000, max: 999999 } }
                    draw:
                        text-blend-order:
                            anchor: center
                            visible: *text_visible_populated_places
                            priority: 8
                            font:
                                size: 14px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                                    
                z9places-2b:
                    filter:
                        any:
                            - { population: { min: 150000, max: 350000 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 12
                            font:
                                size: 14px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 11
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 10
                            icons:
                                sprite: capital-m
                                priority: 9

                z9places-3:
                    filter:
                        any:
                            - { population: { min: 85000, max: 149999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 16
                            font:
                                size: 12px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 15
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 14
                                font:
                                    size: 14px
                            icons:
                                sprite: capital-m
                                priority: 13

                z9places-4:
                    filter:
                        any:
                            - { population: { min: 50000, max: 84999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 20
                            font:
                                size: 10px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 19
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 18
                            icons:
                                sprite: capital-s
                                priority: 17
                z9places-5:
                    filter:
                        all:
                            - { population: { max: 50000 } }
                        any:
                            - { capital: yes }
                            - { state_capital: yes }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 20
                            font:
                                size: 10px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 19
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 18
                            icons:
                                sprite: capital-s
                                priority: 17

            populated-places-osm-z9-no-population:
                filter:
                    all:
                        - source: [openstreetmap, openstreetmap.org]
                        - name: true
                        - population: false
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [9]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        # anchor: center
                        visible: *text_visible_populated_places
                        offset: [0, 3px] # half icon size
                        priority: 22
                        font:
                            size: 10px
                            fill: *text_fill
                            stroke: { color: *text_stroke, width: 4 }
                    icons:
                        size: 5px
                        visible: *icon_visible_populated_places
                        sprite: townspot-s-rev
                        priority: 21

            populated-places-natural-earth-z9-backfill:
                filter: { name: true, source: naturalearthdata.com, $zoom: [9], population: { max: 50000 } }
                draw: { text-blend-order: { font: { fill: *text_fill } } }
                z9places-1-ne:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 4px] # half icon size
                            priority: 26
                            font:
                                size: 17px
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 8px
                            visible: *icon_visible_populated_places
                            sprite: townspot-l-rev
                            priority: 25
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 24
                            icons:
                                sprite: capital-l
                                priority: 23

                z9places-2-ne:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 30
                            font:
                                size: 14px
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 29
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 27
                            icons:
                                sprite: capital-m
                                priority: 28

                z9places-3-ne:
                    filter: { scalerank: [6,7,8,9] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 34
                            font:
                                size: 12px
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 33
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 32
                            icons:
                                sprite: capital-m
                                priority: 31

            populated-places-osm-z10:
                filter:
                    all:
                        - source: [openstreetmap, openstreetmap.org]
                        - name: true
                        - population: true
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [10]

                z10places-1:
                    filter:
                        any:
                            - { population: { min: 1000000 } }
                    draw:
                        text-blend-order:
                            anchor: center
                            visible: *text_visible_populated_places
                            priority: 5
                            font:
                                size: 17px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }

                z10places-2a:
                    filter:
                        any:
                            - { population: { min: 350000, max: 1000000 } }
                    draw:
                        text-blend-order:
                            anchor: center
                            visible: *text_visible_populated_places
                            priority: 6
                            font:
                                size: 14px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }

                z10places-2b:
                    filter:
                        any:
                            - { population: { min: 150000, max: 350000 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 8
                            font:
                                size: 14px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 7

                z10places-3:
                    filter:
                        any:
                            - { population: { min: 50000, max: 149999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 12
                            font:
                                size: 12px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 11

                z10places-4:
                    filter:
                        any:
                            - { population: { min: 20000, max: 49999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 14
                            font:
                                size: 10px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 13

            populated-places-osm-z10-no-population:
                filter:
                    all:
                        - source: [openstreetmap, openstreetmap.org]
                        - name: true
                        - population: false
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [10]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        # anchor: center
                        visible: *text_visible_populated_places
                        offset: [0, 3px] # half icon size
                        priority: 16
                        font:
                            size: 10px
                            fill: *text_fill
                            stroke: { color: *text_stroke, width: 4 }
                    icons:
                        size: 5px
                        visible: *icon_visible_populated_places
                        sprite: townspot-s-rev
                        priority: 15

            populated-places-natural-earth-z10-backfill:
                filter: { name: true, source: naturalearthdata.com, $zoom: [10], population: { max: 20000 } }
                draw: { text-blend-order: { font: { fill: *text_fill } } }
                z10places-1-ne:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 2px] # half icon size
                            priority: 17
                            font:
                                size: 17px
                                stroke: { color: *text_stroke, width: 4 }

                z10places-2-ne:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 22
                            font:
                                size: 14px
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 6px
                            visible: *icon_visible_populated_places
                            sprite: townspot-m-rev
                            priority: 21
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 21
                            icons:
                                sprite: capital-m
                                priority: 20

                z10places-3-ne:
                    filter: { scalerank: [6,7,8,9,10] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            offset: [0, 3px] # half icon size
                            priority: 26
                            font:
                                size: 12px
                                stroke: { color: *text_stroke, width: 4 }
                        icons:
                            size: 5px
                            visible: *icon_visible_populated_places
                            sprite: townspot-s-rev
                            priority: 25
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 24
                            icons:
                                size: 7px
                                sprite: capital-m
                                priority: 23

            populated-places-osm-z11:
                filter:
                    all:
                        - source: [openstreetmap, openstreetmap.org]
                        - name: true
                        - population: true
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [11]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        anchor: center

                z11places-1:
                    filter:
                        any:
                            - { population: { min: 1000000 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 5
                            font:
                                size: 18px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }

                z11places-2:
                    filter:
                        any:
                            - { population: { min: 50000, max: 999999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 6
                            font:
                                size: 14px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }

                z11places-3:
                    filter:
                        any:
                        - { population: { min: 5000, max: 49999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 7
                            font:
                                size: 11px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }

            populated-places-osm-z11-no-population:
                filter:
                    all:
                        - source: [openstreetmap, openstreetmap.org]
                        - name: true
                        - population: false
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [11]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        anchor: center
                        visible: *text_visible_populated_places
                        priority: 8
                        font:
                            size: 11px
                            fill: *text_fill
                            stroke: { color: *text_stroke, width: 4 }

            populated-places-natural-earth-z11-backfill:
                filter: { name: true, source: naturalearthdata.com, $zoom: [11], population: { max: 5000 } }
                draw:
                    text-blend-order:
                        anchor: center
                        font:
                            fill: *text_fill
                z11places-1-ne:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 10
                            font:
                                size: 18px
                                stroke: { color: *text_stroke, width: 4 }
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 9
                                font:
                                    size: 18px
                                    stroke: { color: *text_stroke, width: 4 }

                z11places-2-ne:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 13
                            font:
                                size: 14px
                                stroke: { color: *text_stroke, width: 4 }
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 11
                                font:
                                    size: 14px
                                    stroke: { color: *text_stroke, width: 4 }
                    state_capital:
                        filter: { state_capital: yes }
                        draw:
                            text-blend-order:
                                priority: 12
                                font:
                                    size: 14px
                                    stroke: { color: *text_stroke, width: 4 }

                z11places-3-ne:
                    filter: { scalerank: [6,7,8,9,10,11] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 15
                            font:
                                size: 11px
                                stroke: { color: *text_stroke, width: 4 }
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 14
                                font:
                                    size: 11px
                                    stroke: { color: *text_stroke, width: 4 }

            populated-places-osm-z12:
                filter:
                    all:
                        - source: [openstreetmap, openstreetmap.org]
                        - name: true
                        - population: true
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [12]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        anchor: center

                z12places-1:
                    filter:
                        any:
                            - { population: { min: 1000000 } }

                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 5
                            font:
                                size: 18px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }

                z12places-2:
                    filter:
                        any:
                            - { population: { min: 50000, max: 999999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 6
                            font:
                                size: 14px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }

                z12places-3:
                    filter:
                        any:
                        - { population: { min: 5000, max: 49999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 7
                            font:
                                size: 11px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }

                z12places-4:
                    filter:
                        any:
                        - { population: { max: 5000 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 8
                            font:
                                size: 11px
                                fill: *text_fill
                                stroke: { color: *text_stroke, width: 4 }

            populated-places-osm-z12-no-population:
                filter:
                    all:
                        - source: [openstreetmap, openstreetmap.org]
                        - name: true
                        - population: false
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [12]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        anchor: center
                        visible: *text_visible_populated_places
                        priority: 9
                        font:
                            size: 11px
                            fill: *text_fill
                            stroke: { color: *text_stroke, width: 4 }

            populated-places-natural-earth-z12-backfill:
                filter: { name: true, source: naturalearthdata.com, $zoom: [12], population: { max: 5000 } }
                draw:
                    text-blend-order:
                        anchor: center
                        priority: 10
                        font:
                            fill: *text_fill

                z12places-1-ne:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 12
                            font:
                                size: 18px
                                stroke: { color: *text_stroke, width: 4 }
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 11
                                font:
                                    size: 18px
                                    stroke: { color: *text_stroke, width: 4 }

                z12places-2-ne:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 14
                            font:
                                size: 14px
                                stroke: { color: *text_stroke, width: 4 }
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 13
                                font:
                                    size: 14px
                                    stroke: { color: *text_stroke, width: 4 }

                z12places-3-ne:
                    filter: { scalerank: [6,7,8,9,10,11,12] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 16
                            font:
                                size: 11px
                                stroke: { color: *text_stroke, width: 4 }
                    capital:
                        filter: { capital: yes }
                        draw:
                            text-blend-order:
                                priority: 15
                                font:
                                    size: 11px
                                    stroke: { color: *text_stroke, width: 4 }

            populated-places-osm-z13-z14:
                filter:
                    all:
                        - source: [openstreetmap, openstreetmap.org]
                        - name: true
                        - population: true
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [13,14]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        anchor: center
                        visible: *text_visible_populated_places
                        font:
                            weight: 600
                            fill: *text_fill
                z14:
                    filter:
                        $zoom: [14]
                    draw:
                        text-blend-order:
                            font:
                                weight: 600

                z13places-1:
                    filter:
                        any:
                            - { population: { min: 200000 } }
                    draw:
                        text-blend-order:
                            visible: false

                z13places-2:
                    filter:
                        any:
                            - { population: { min: 50000, max: 199999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 5
                            font:
                                size: 14px
                                stroke: { color: *text_stroke, width: 4 }

                z13places-3:
                    filter:
                        any:
                        - { population: { min: 5000, max: 49999 } }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 6
                            font:
                                size: 12px
                                stroke: { color: *text_stroke, width: 4 }

                z13places-4:
                    filter:
                        any:
                            - population: false
                            - population: true
                              all:
                                - population: { max: 5000 }
                    draw:
                        text-blend-order:
                            font:
                                size: 12px
                                stroke: { color: *text_stroke, width: 4 }

            populated-places-osm-z13-z14-no-population:
                filter:
                    all:
                        - source: [openstreetmap, openstreetmap.org]
                        - name: true
                        - population: false
                        - not: { kind: [country, county, state, island, neighbourhood, suburb, quarter] }
                        - $zoom: [13, 14]
                        - kind: [city,town]
                draw:
                    text-blend-order:
                        anchor: center
                        visible: *text_visible_populated_places
                        priority: 7
                        font:
                            size: 11px
                            stroke: { color: *text_stroke, width: 4 }

            populated-places-natural-earth-z13-z14-backfill:
                filter: { name: true, source: naturalearthdata.com, $zoom: [13,14], population: { max: 5000 } }
                draw:
                    text-blend-order:
                        anchor: center
                        font:
                            fill: *text_fill
                            weight: 400

                z13places-1-ne:
                    filter: { scalerank: [0,1] }
                    draw:
                        text-blend-order:
                            priority: 8
                            interactive: false
                            visible: false

                z13places-2-ne:
                    filter: { scalerank: [2,3,4,5] }
                    draw:
                        text-blend-order:
                            priority: 9
                            visible: *text_visible_populated_places
                            font:
                                size: 13px
                                stroke: { color: *text_stroke, width: 4 }

                z13places-3-ne:
                    filter: { scalerank: [6,7,8,9,10,11,12] }
                    draw:
                        text-blend-order:
                            visible: *text_visible_populated_places
                            priority: 10
                            font:
                                size: 12px
                                stroke: { color: *text_stroke, width: 4 }

            neighborhood-z11:
                filter:
                    all:
                        - name: true
                        - kind: [macrohood, neighbourhood]
                        - $zoom: [11]
                    any:
                        - source: [openstreetmap, openstreetmap.org]
                        - source: [whosonfirst, whosonfirst.mapzen.com]
                          all:
                            - min_zoom: [11]
                            - max_zoom: { min: 12 }
                            - is_landuse_aoi: false
                            #- kind_tile_rank: { max: 6 }
                draw:
                    text-blend-order:
                        priority: 18
                        text_wrap: 10
                        visible: *text_visible_neighbourhoods_e
                        font:
                            size: 9px
                            weight: 400
                            fill: [0.600,0.600,0.600]
                            transform: uppercase
                            stroke: { color: [1.0,1.0,1.0,0.7], width: 4 }
            neighborhood-z12:
                filter:
                    all:
                        - name: true
                        - kind: [macrohood, neighbourhood]
                        - $zoom: [12]
                    any:
                        - source: [openstreetmap, openstreetmap.org]
                        - source: [whosonfirst, whosonfirst.mapzen.com]
                          all:
                            - min_zoom: [11,12]
                            - max_zoom: { min: 13 }
                            - is_landuse_aoi: false
                            #- kind_tile_rank: { max: 8 }
                draw:
                    text-blend-order:
                        priority: 18
                        text_wrap: 10
                        visible: *text_visible_neighbourhoods_e
                        font:
                            size: 10px
                            weight: 400
                            fill: [0.600,0.600,0.600]
                            transform: uppercase
                            stroke: { color: [1.0,1.0,1.0,0.7], width: 4 }
            neighborhood-z13:
                filter:
                    all:
                        - name: true
                        - kind: [macrohood, neighbourhood]
                        - $zoom: [13]
                    any:
                        - source: [openstreetmap, openstreetmap.org]
                        - source: [whosonfirst, whosonfirst.mapzen.com]
                          all:
                            - min_zoom: [11,12,13]
                            - max_zoom: { min: 14 }
                            - is_landuse_aoi: false
                            - kind_tile_rank: { max: 8 }
                draw:
                    text-blend-order:
                        priority: 18
                        text_wrap: 10
                        visible: *text_visible_neighbourhoods_e
                        font:
                            size: 12px
                            weight: 300
                            fill: [0.620,0.620,0.620]
                            transform: uppercase
                            stroke: { color: [1.0,1.0,1.0,0.7], width: 6 }
            neighborhood-z14:
                filter:
                    all:
                        - name: true
                        - kind: [macrohood, neighbourhood]
                        - $zoom: [14]
                    any:
                        - source: [openstreetmap, openstreetmap.org]
                        - source: [whosonfirst, whosonfirst.mapzen.com]
                          all:
                            - min_zoom: [11,12,13,14]
                            - max_zoom: { min: 15 }
                            - is_landuse_aoi: false
                            - kind_tile_rank: { max: 8 }
                draw:
                    text-blend-order:
                        priority: 18
                        text_wrap: 12
                        visible: *text_visible_neighbourhoods
                        font:
                            size: 16px
                            weight: 200
                            fill: [0.600,0.600,0.600]
                            transform: uppercase
                            stroke: { color: [1.0,1.0,1.0,0.7], width: 6 }
            neighborhood-z15:
                filter:
                    all:
                        - name: true
                        - kind: [macrohood, neighbourhood]
                        - $zoom: [15]
                    any:
                        - source: [openstreetmap, openstreetmap.org]
                        - source: [whosonfirst, whosonfirst.mapzen.com]
                          all:
                            - min_zoom: [11,12,13,14,15]
                            - max_zoom: { min: 16 }
                            - is_landuse_aoi: false
                            - kind_tile_rank: { max: 8 }
                draw:
                    text-blend-order:
                        priority: 18
                        text_wrap: 12
                        visible: *text_visible_neighbourhoods
                        font:
                            size: 21px
                            weight: 200
                            fill: [0.650,0.650,0.650]
                            transform: uppercase
                            stroke: { color: [1.0,1.0,1.0,0.6], width: 8 }
                z15-new:
                    filter: 
                        all:
                            - min_zoom: 15
                    draw:
                        text-blend-order:
                            priority: 19
                            font:
                                size: 13px
            neighborhood-z16:
                filter:
                    all:
                        - name: true
                        - kind: [macrohood, neighbourhood]
                        - $zoom: [16]
                    any:
                        - source: [openstreetmap, openstreetmap.org]
                        - source: [whosonfirst, whosonfirst.mapzen.com]
                          all:
                            - min_zoom: [11,12,13,14,15,16]
                            - max_zoom: { min: 17 }
                            - is_landuse_aoi: false
                            - kind_tile_rank: { max: 8 }
                draw:
                    text-blend-order:
                        priority: 18
                        visible: *text_visible_neighbourhoods
                        font:
                            size: 24px
                            weight: 300
                            fill: [0.00,0.00,0.00,0.50]
                            transform: uppercase
                            stroke: { color: [1.0,1.0,1.0,0.85], width: 4 }

    highway-exit:
        data: { source: osm, layer: [pois] }
        filter: { kind: motorway_junction, $zoom: { min: 14 } }
        draw:
            icons:
                visible: false
            text-blend-order:
                visible: *text_visible_exits
                interactive: true
                text_source: ref
                priority: 52
                font:
                    fill: [1.0,1.0,1.0] # *text_fill_exits
                    size: [[12,9px],[15,10px],[17,12px]]
                    stroke: { color: [0.25,0.25,0.25], width: [[14,3px],[15,4px]] }
        later:
            filter: { $zoom: { min: 16 } }
            draw:
                text-blend-order:
                    font:
                        weight: 600
    airport-gate:
        data: { source: osm, layer: [pois] }
        filter: { kind: gate, aeroway: gate }
        draw:
            icons:
                visible: false
            text-blend-order:
                visible: *text_visible_airport_gate
                interactive: true
                text_source: ref
                font:
                    fill: [0.50,0.50,0.50]
                    size: [[16,9px],[17,12px],[20,14px]]
                    #stroke: { color: [1.0,1.0,1.0], width: 4px }
        later:
            filter: { $zoom: { min: 19 } }
            draw:
                text-blend-order:
                    font:
                        weight: 600
